<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊúàÊñáÂ≠ó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº | Êúà„ÅÆÁµµÊñáÂ≠ó„Ç¢„Éº„Éà‰ΩúÊàê | ÁÑ°Êñô„ÉÜ„Ç≠„Çπ„ÉàÂ§âÊèõ„ÉÑ„Éº„É´ - MojiMoon</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Êó•Êú¨Ë™û„ÉÜ„Ç≠„Çπ„Éà„ÇíÁæé„Åó„ÅÑÊúà„ÅÆÁµµÊñáÂ≠ó„Ç¢„Éº„Éà„Å´Â§âÊèõ„Åô„ÇãÁÑ°Êñô„Ç™„É≥„É©„Ç§„É≥„ÉÑ„Éº„É´„ÄÇÁ∏¶Êõ∏„Åç„ÉªÊ®™Êõ∏„ÅçÂØæÂøú„ÄÅË§áÊï∞„Éï„Ç©„É≥„ÉàÈÅ∏ÊäûÂèØËÉΩ„ÄÇÊúà„ÅÆÊ∫ÄÊ¨†„ÇíË°®Áèæ„Åó„Åü„É¶„Éã„Éº„ÇØ„Å™„Ç¢„Çπ„Ç≠„Éº„Ç¢„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åø„Åæ„Åõ„Çì„ÅãÔºü">
    <meta name="keywords" content="ÊúàÊñáÂ≠ó,ÁµµÊñáÂ≠ó„Ç¢„Éº„Éà,„ÉÜ„Ç≠„Çπ„Éà„Ç¢„Éº„Éà,„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº,ÁÑ°Êñô„ÉÑ„Éº„É´">
    <meta name="author" content="ÊúàÊñáÂ≠ó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº">
    <meta name="robots" content="index,follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="ÊúàÊñáÂ≠ó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº">
    <meta property="og:description" content="„ÉÜ„Ç≠„Çπ„Éà„ÇíÊúà„ÅÆÁµµÊñáÂ≠ó„Ç¢„Éº„Éà„Å´Â§âÊèõ„Åô„ÇãÁÑ°Êñô„ÉÑ„Éº„É´">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mojimoon.com/">
    <meta property="og:image" content="https://mojimoon.com/moon_icon.png">
    <meta property="og:locale" content="ja_JP">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@mojimoon">
    <meta name="twitter:title" content="ÊúàÊñáÂ≠ó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº">
    <meta name="twitter:description" content="„ÉÜ„Ç≠„Çπ„Éà„ÇíÊúà„ÅÆÁµµÊñáÂ≠ó„Ç¢„Éº„Éà„Å´Â§âÊèõ">
    <meta name="twitter:image" content="https://mojimoon.com/moon_icon.png">
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåô</text></svg>">
    <link rel="icon" type="image/png" sizes="32x32" href="/moon_icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/moon_icon.png">
    <link rel="apple-touch-icon" href="/moon_icon.png">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://mojimoon.com/">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "ÊúàÊñáÂ≠ó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº",
        "description": "„ÉÜ„Ç≠„Çπ„Éà„ÇíÊúà„ÅÆÁµµÊñáÂ≠ó„Ç¢„Éº„Éà„Å´Â§âÊèõ",
        "applicationCategory": "UtilityApplication",
        "operatingSystem": "All",
        "inLanguage": "ja",
        "isAccessibleForFree": true
    }
    </script>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WD9XP5ERGX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-WD9XP5ERGX');
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .text-input {
            width: 100%;
            height: 48px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }
        
        .text-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .height-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .height-slider {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .height-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #fbbf24;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.4);
            transition: all 0.2s ease;
        }
        
        .height-slider::-webkit-slider-thumb:hover {
            background: #f59e0b;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.6);
        }
        
        .font-select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .font-select option {
            background: #4c1d95;
            color: white;
        }
        
        .generate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
        }
        
        .preview-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            min-height: 300px;
            width: fit-content;
            min-width: 100%;
            max-width: fit-content;
        }
        
        .moon-art {
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
            letter-spacing: 0.1em;
            white-space: pre;
            width: fit-content;
            color: #fff;
            padding-top: 5px;
        }
        
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            flex: 1;
            min-width: 140px;
        }
        
        .copy-btn {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .copy-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
        }
        
        .download-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
        
        .download-btn:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-1px);
        }
        
        .btn-icon {
            font-size: 16px;
        }
        
        .btn-text {
            font-size: 13px;
        }
        
        .copy-btn.success {
            background: linear-gradient(135deg, #059669, #047857);
        }
        
        .direction-control {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .radio-option input[type="radio"],
        .radio-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #8b5cf6;
        }
        
        .radio-label {
            font-weight: 500;
        }
        
        /* „Éï„ÉÉ„Çø„Éº„Çπ„Çø„Ç§„É´ */
        .footer {
            margin-top: 40px;
            padding: 20px 15px;
        }
        
        .footer-bookmark-btn {
            background: none;
            border: none;
            color: #fbbf24;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            padding: 0;
            margin: 0 2px;
            transition: color 0.2s ease;
        }
        
        .footer-bookmark-btn:hover {
            color: #f59e0b;
        }
        
        /* ÊÇ¨ÊµÆÊî∂ËóèÊåâÈíÆ */
        .floating-bookmark {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            gap: 6px;
        }
        
        .floating-bookmark:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(251, 191, 36, 0.5);
        }
        
        /* ÁßªÂä®Á´Ø‰ºòÂåñ */
        @media (max-width: 768px) {
            .header {
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 5px;
            }
            
            .control-panel {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-group h3 {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }
            
            .floating-bookmark {
                display: none;
            }
            
            body {
                padding-top: 10px;
            }
            
            .footer h2 {
                font-size: 1.1rem;
            }
            
            /* ÁßªÂä®Á´ØÊåâÈíÆ‰ºòÂåñ - ÂçïË°åÂ∏ÉÂ±Ä */
            .action-buttons {
                gap: 5px;
                flex-wrap: nowrap;
            }
            
            .action-btn {
                min-width: 0;
                padding: 8px 6px;
                font-size: 12px;
                flex: 1;
            }
            
            .btn-icon {
                font-size: 14px;
            }
            
            .btn-text {
                font-size: 11px;
            }
        }
        
        /* TabÊ†∑Âºè */
        .input-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .tab-button {
            flex: 1;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
            font-weight: 600;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab-button.active {
            color: white;
            border-bottom-color: #fbbf24;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .tab-button:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ÂõæÁâá‰∏ä‰º†Âå∫ÂüüÊ†∑Âºè */
        .image-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .image-upload-area:hover {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }
        
        .image-upload-area.dragover {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.15);
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .upload-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
        }
        
        .upload-hint {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 16px;
        }
        
        .upload-button {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }
        
        .image-preview {
            display: none;
            margin-top: 16px;
            text-align: center;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .image-info {
            margin-top: 12px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .remove-image {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }
        
        .remove-image:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Ë∞ÉËØïÂèÇÊï∞ÊäòÂè†Ê†∑Âºè */
        .debug-header:hover {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 8px;
            margin: -8px;
        }
        
        .debug-controls {
            max-height: 0;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .debug-controls.expanded {
            max-height: 500px;
            opacity: 1;
            display: block !important;
        }
    </style>
</head>
<body>
    <!-- Floating Bookmark Button -->
    <button id="bookmarkBtn" class="floating-bookmark" title="„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†">
        ‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„Çä
    </button>
    
    <div class="container">
        <header class="header">
            <h1>üåô ÊúàÊñáÂ≠ó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº</h1>
        </header>
        
        <div class="control-panel">
            <!-- ËæìÂÖ•Ê®°ÂºèTab -->
            <div class="input-tabs">
                <button class="tab-button active" data-tab="text">„ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ</button>
                <button class="tab-button" data-tab="image">ÁîªÂÉèÂÖ•Âäõ</button>
            </div>
            
            <!-- ÊñáÂ≠óËæìÂÖ•TabÂÜÖÂÆπ -->
            <div class="tab-content active" id="textTab">
                <div class="form-group">
                    <input type="text" id="textInput" class="text-input" placeholder="Â§âÊèõ„Åó„Åü„ÅÑ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" value="ÊúàÊñáÂ≠ó">
                </div>
                
                <div class="form-group">
                    <div class="direction-control">
                        <label class="radio-option">
                            <input type="radio" name="textDirection" value="vertical">
                            <span class="radio-label">Á∏¶Êõ∏„Åç</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="textDirection" value="horizontal">
                            <span class="radio-label">Ê®™Êõ∏„Åç</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; gap: 20px; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 8px; font-size: 1rem; font-weight: 600;">„Éï„Ç©„É≥„ÉàÈÅ∏Êäû</h3>
                            <select id="fontSelect" class="font-select">
                                <option value="default" selected>„Ç∑„Çπ„ÉÜ„É†Êó¢ÂÆö</option>
                                <option value="gothic">„Ç¥„Ç∑„ÉÉ„ÇØ‰Ωì</option>
                                <option value="mincho">ÊòéÊúù‰Ωì</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">ÊñáÂ≠óÈñìÈöî: <span id="spacingValue">2</span></label>
                            <div class="height-control">
                                <span>0</span>
                                <input type="range" id="spacingSlider" class="height-slider" min="0" max="10" value="2">
                                <span>10</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ÂõæÁâáËæìÂÖ•TabÂÜÖÂÆπ -->
            <div class="tab-content" id="imageTab">
                <div class="form-group">
                    <div class="image-upload-area" id="imageUploadArea">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-text">ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</div>
                        <div class="upload-hint">JPG, PNG, GIF „Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû</div>
                        <button class="upload-button" id="uploadButton">„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</button>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    </div>
                    <div class="image-preview" id="imagePreview">
                        <img id="previewImg" src="" alt="„Éó„É¨„Éì„É•„Éº">
                        <div class="image-info" id="imageInfo"></div>
                        <button class="remove-image" id="removeImage">ÁîªÂÉè„ÇíÂâäÈô§</button>
                    </div>
                </div>
                
            </div>
            
            <!-- TabÂ§ñÈÉ®ÈÄöÁî®ÈÄâÈ°π -->
            <div class="form-group">
                <!-- Á¨¨‰∏ÄË°åÔºöÈ´ò„Åï + ‰ΩôÁôΩ -->
                <div style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            <span id="sliderLabel">È´ò„Åï</span>: 
                            <span id="heightValue">10</span>
                            <span id="sliderUnit">Ë°å</span>
                        </label>
                        <div class="height-control">
                            <span>10</span>
                            <input type="range" id="heightSlider" class="height-slider" min="10" max="60" value="10">
                            <span>60</span>
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            ‰ΩôÁôΩ: <span id="paddingValue">0</span>
                        </label>
                        <div class="height-control">
                            <span>0</span>
                            <input type="range" id="paddingSlider" class="height-slider" min="0" max="5" value="0">
                            <span>5</span>
                        </div>
                    </div>
                </div>
                
                <!-- Á¨¨‰∫åË°åÔºöÂèçËâ≤ÔºàÂ∑¶ÂØπÈΩêÔºâ -->
                <div>
                    <label style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
                        <input type="checkbox" id="reverseColor">
                        <span>ÂèçËâ≤</span>
                    </label>
                </div>
            </div>
            
            <!-- Ë∞ÉËØïÂèÇÊï∞Âå∫Âüü -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                <div class="debug-header" style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; margin-bottom: 15px;" onclick="toggleDebugSection()">
                    <h3 style="margin: 0; font-size: 1rem; font-weight: 600; color: #fbbf24;">Ë∞ÉËØïÂèÇÊï∞</h3>
                    <span id="debugToggleIcon" style="color: #fbbf24; font-size: 1rem; transition: transform 0.3s ease;">‚ñ∂</span>
                </div>
                
                <!-- ÂèØÊî∂Ëµ∑ÁöÑË∞ÉËØïÊéß‰ª∂ÂÆπÂô® -->
                <div id="debugControls" class="debug-controls" style="display: none; overflow: hidden; transition: all 0.3s ease;">
                    <div class="form-group">
                        <label>Ê®™ÂêëÁ≤òÂêàÁ≥ªÊï∞: <span id="adhesionValue">2</span></label>
                        <div class="height-control">
                            <span>0</span>
                            <input type="range" id="adhesionSlider" class="height-slider" min="0" max="6" value="2">
                            <span>6</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4 style="margin-bottom: 10px; font-size: 0.9rem; font-weight: 600;">ÂûÇÁõ¥ÂåñÂ§ÑÁêÜ</h4>
                        <div style="display: flex; gap: 20px;">
                            <label class="radio-option">
                                <input type="checkbox" id="verticalMedium" checked>
                                <span class="radio-label">‰∏≠Á≠âÂØÜÂ∫¶</span>
                            </label>
                            <label class="radio-option">
                                <input type="checkbox" id="verticalHigh" checked>
                                <span class="radio-label">Ê¨°È´òÂØÜÂ∫¶</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4 style="margin-bottom: 10px; font-size: 0.9rem; font-weight: 600;">Ê®™ÂêëÂä†Âº∫ÁÆóÊ≥ï</h4>
                        <div style="display: flex; gap: 20px;">
                            <label class="radio-option">
                                <input type="checkbox" id="enableDenoising" checked>
                                <span class="radio-label">ÂéªÂô™Â§ÑÁêÜ</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4 style="margin-bottom: 10px; font-size: 0.9rem; font-weight: 600;">Ë∞ÉËØïÊòæÁ§∫</h4>
                        <div style="display: flex; gap: 20px;">
                            <label class="radio-option">
                                <input type="checkbox" id="showVerticalInfo">
                                <span class="radio-label">ÂûÇÁõ¥ÂåñÊÉÖÂ†±</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            
            
            <!-- Action Buttons -->
            <div id="actionButtons" class="action-buttons" style="display: none;">
                <button id="copyBtn" class="action-btn copy-btn">
                    <span class="btn-icon">üìã</span>
                    <span class="btn-text">„Ç≥„Éî„Éº</span>
                </button>
                <button id="downloadTextBtn" class="action-btn download-btn">
                    <span class="btn-icon">üìÑ</span>
                    <span class="btn-text">„ÉÜ„Ç≠„Çπ„Éà„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</span>
                </button>
                <button id="downloadImageBtn" class="action-btn download-btn">
                    <span class="btn-icon">üñºÔ∏è</span>
                    <span class="btn-text">ÁîªÂÉè„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Preview Panel (expandable) -->
    <div class="container" style="max-width: none; min-width: 800px; width: fit-content;">
        <div class="preview-panel">
            <h2 style="margin-bottom: 8px; font-size: 12px; font-weight: 600;">„Éó„É¨„Éì„É•„Éº</h2>
            
            <!-- Debug info for vertical processing -->
            <div id="debugInfo" style="margin-bottom: 10px; font-size: 11px; color: #fbbf24; font-family: monospace; display: none;">
                <div>ÂûÇÁõ¥ÂåñÂá¶ÁêÜ: <span id="verticalProcessingStatus">ÊúâÂäπ</span></div>
                <div>ÂØæË±°ÂØÜÂ∫¶„É¨„Éô„É´: <span id="targetDensityLevels">‰∏≠Á≠âÂØÜÂ∫¶</span></div>
                <div>ÈñæÂÄ§n: <span id="thresholdN">2</span></div>
                <div>Âá¶ÁêÜ„É¢„Éº„Éâ: <span id="processingMode">‰∏≠Á≠âÂØÜÂ∫¶Ôºà„Éê„É©„É≥„ÇπÈáçÂøÉ„ÅÆ„ÅøÔºâ</span></div>
            </div>
            
            <div id="moonArt" class="moon-art"><!-- ÁîüÊàêÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô --></div>
            
            <!-- Debug controls (hidden for production) -->
            <div style="margin-top: 20px; display: none;">
                <label>
                    <input type="checkbox" id="showDebugCanvas"> ÊòæÁ§∫ÂéüÂßãCanvasË∞ÉËØï
                </label>
            </div>
            
            <!-- Debug canvas (hidden for production) -->
            <canvas id="debugCanvas" style="border: 1px solid #666; margin-top: 10px; background: white; display: none; max-width: 100%;"></canvas>
            
            
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÁä∂ÊÄÅÁÆ°ÁêÜ
        let currentInputMode = 'text'; // 'text' or 'image'
        let lastUploadedImageSrc = null; // ‰øùÂ≠òÊúÄÂêé‰∏ä‰º†ÁöÑÂõæÁâáÊï∞ÊçÆ
        
        // ÂàÜÂà´‰øùÂ≠òÊñáÂ≠óÊ®°ÂºèÂíåÂõæÁâáÊ®°ÂºèÁöÑËÆæÁΩÆ
        let textModeSettings = {
            height: 10,
            padding: 0
        };
        
        let imageModeSettings = {
            height: 60,
            padding: 0
        };
        
        // ÁÆÄÂåñÁöÑÈ¢úËâ≤Á∫ßÂà´ÔºöÂè™ÊúâÈªëÁôΩ‰∏§Ëâ≤
        const COLOR_LEVELS = {
            BLACK: 0,
            WHITE: 1
        };
        
        // ÂõæÁâáÂ§ÑÁêÜÁ±ª - Áî®‰∫éÂ§ÑÁêÜÂõæÁâáËæìÂÖ•Âπ∂ËΩ¨Êç¢‰∏∫ÂÉèÁ¥†Áü©Èòµ
        class ImageProcessor {
            constructor() {
                this.threshold = 128; // ‰∫åÂÄºÂåñÈòàÂÄº
                
                // 5x5 BayerÊäñÂä®Áü©ÈòµÔºàÁî®‰∫éÁÅ∞Â∫¶Â§ÑÁêÜÔºâ
                this.bayerMatrix5x5 = [
                    [ 0, 12,  3, 15,  8],
                    [18,  6, 21,  9, 24],
                    [ 4, 16,  1, 13,  5],
                    [22, 10, 19,  7, 23],
                    [ 2, 14, 11, 20, 17]
                ];
            }
            
            // Âä†ËΩΩÂπ∂Â§ÑÁêÜÂõæÁâáÔºàÊîØÊåÅÁÅ∞Â∫¶Â§ÑÁêÜÊ®°ÂºèÔºâ
            async loadAndProcessImage(imageSrc, targetHeight, useGrayScale = false) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        try {
                            // ÂàõÂª∫canvasÊù•Â§ÑÁêÜÂõæÁâá
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // ËÆ°ÁÆóÁõÆÊ†áÂ∞∫ÂØ∏Ôºà‰øùÊåÅÂÆΩÈ´òÊØîÔºâ
                            const aspectRatio = img.width / img.height;
                            const targetPixelHeight = targetHeight * 5; // 5x5Á≥ªÁªü
                            const targetPixelWidth = Math.round(targetPixelHeight * aspectRatio);
                            
                            // Á°Æ‰øùÂ∞∫ÂØ∏ÊòØ5ÁöÑÂÄçÊï∞
                            const finalHeight = Math.ceil(targetPixelHeight / 5) * 5;
                            const finalWidth = Math.ceil(targetPixelWidth / 5) * 5;
                            
                            // ËÆæÁΩÆcanvasÂ∞∫ÂØ∏Âπ∂ÁªòÂà∂ÂõæÁâá
                            canvas.width = finalWidth;
                            canvas.height = finalHeight;
                            ctx.drawImage(img, 0, 0, finalWidth, finalHeight);
                            
                            // Ëé∑ÂèñÂõæÂÉèÊï∞ÊçÆ
                            const imageData = ctx.getImageData(0, 0, finalWidth, finalHeight);
                            
                            // Ê†πÊçÆÊ®°ÂºèÈÄâÊã©Â§ÑÁêÜÊñπÊ≥ï
                            const processedMatrix = useGrayScale 
                                ? this.applyOrderedDithering(imageData)
                                : this.binarizeImage(imageData);
                            
                            console.log(`ÂõæÁâáÂ§ÑÁêÜÂÆåÊàê: ÂéüÂßãÂ∞∫ÂØ∏=${img.width}x${img.height}, ÁõÆÊ†áÂ∞∫ÂØ∏=${finalWidth}x${finalHeight}, ÁÅ∞Â∫¶Ê®°Âºè=${useGrayScale}`);
                            
                            resolve({
                                matrix: processedMatrix,
                                width: finalWidth,
                                height: finalHeight
                            });
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    img.onerror = () => {
                        reject(new Error('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•'));
                    };
                    
                    img.src = imageSrc;
                });
            }
            
            // ‰∫åÂÄºÂåñÂõæÂÉèÊï∞ÊçÆ
            binarizeImage(imageData) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                const binaryMatrix = [];
                
                for (let y = 0; y < height; y++) {
                    const row = [];
                    for (let x = 0; x < width; x++) {
                        const idx = (y * width + x) * 4;
                        // ËÆ°ÁÆóÁÅ∞Â∫¶ÂÄº
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];
                        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                        
                        // ‰∫åÂÄºÂåñÔºö0=ÈªëËâ≤Ôºå1=ÁôΩËâ≤
                        row.push(gray < this.threshold ? 0 : 1);
                    }
                    binaryMatrix.push(row);
                }
                
                return binaryMatrix;
            }
            
            // ÊúâÂ∫èÊäñÂä®Â§ÑÁêÜÔºàÁî®‰∫éÁÅ∞Â∫¶Ê®°ÂºèÔºâ
            applyOrderedDithering(imageData) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                const result = [];
                
                for (let y = 0; y < height; y++) {
                    const row = [];
                    for (let x = 0; x < width; x++) {
                        const idx = (y * width + x) * 4;
                        // ËÆ°ÁÆóÁÅ∞Â∫¶ÂÄº
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];
                        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                        
                        // ‰ΩøÁî®BayerÁü©ÈòµÁ°ÆÂÆöÈòàÂÄº
                        const matrixSize = 5;
                        const mx = x % matrixSize;
                        const my = y % matrixSize;
                        // Â∞ÜÁü©ÈòµÂÄºÂΩí‰∏ÄÂåñÂà∞0-255ËåÉÂõ¥
                        const threshold = (this.bayerMatrix5x5[my][mx] + 1) * 255 / 26;
                        
                        // Ê†πÊçÆÈòàÂÄºÂÜ≥ÂÆöÈªëÁôΩ
                        row.push(gray > threshold ? 1 : 0);
                    }
                    result.push(row);
                }
                
                console.log(`ÊúâÂ∫èÊäñÂä®Â§ÑÁêÜÂÆåÊàê: ${width}x${height}ÂÉèÁ¥†`);
                return result;
            }
            
            // ËÆæÁΩÆ‰∫åÂÄºÂåñÈòàÂÄº
            setThreshold(value) {
                this.threshold = value;
            }
        }
        
        // Ê®™ÂêëÂä†Âº∫ÁÆóÊ≥ïM - Ê®°ÂùóÂåñÂÆûÁé∞
        class HorizontalEnhancer {
            constructor() {
                this.adhesionCoefficient = 2; // ÈªòËÆ§Á≤òÂêàÁ≥ªÊï∞
                this.enableDenoising = true; // ÈªòËÆ§ÂêØÁî®ÂéªÂô™Â§ÑÁêÜ
                this.gapDistanceMap = this.initGapDistanceMap();
                
                // Ëá™Ë∫´Á©∫Áº∫Â∫¶Êò†Â∞ÑË°®
                this.selfGapMap = {
                    'üåî': 1,
                    'üåì': 2, 
                    'üåí': 3,
                    'üåë': 4,
                    'üåò': 3,
                    'üåó': 2,
                    'üåñ': 1,
                    'üåï': 0
                };
            }
            
            // ËÆæÁΩÆÁ≤òÂêàÁ≥ªÊï∞
            setAdhesionCoefficient(coefficient) {
                this.adhesionCoefficient = coefficient;
            }
            
            // ËÆæÁΩÆÂéªÂô™ÂºÄÂÖ≥
            setEnableDenoising(enable) {
                this.enableDenoising = enable;
            }
            
            // ÂàùÂßãÂåñÁ©∫Áº∫Â∫¶Êü•ÊâæË°®
            initGapDistanceMap() {
                // Âü∫‰∫éÁÆóÊ≥ïÂÆö‰πâÊé®ÂØºÁöÑÂÆåÊï¥Á©∫Áº∫Â∫¶Ë°®
                const map = {};
                const moons = ['üåë', 'üåò', 'üåó', 'üåñ', 'üåï', 'üåî', 'üåì', 'üåí'];
                
                // üåë‰∏é‰ªª‰ΩïÂ≠óÁ¨¶ÁöÑÁ©∫Áº∫Â∫¶ÈÉΩÊòØ-1
                map['üåë'] = {};
                for (const moon of moons) {
                    map['üåë'][moon] = -1;
                }
                
                // ÂÖ∂‰ªñÊúàÁõ∏‰πãÈó¥ÁöÑÁ©∫Áº∫Â∫¶
                const distances = {
                    'üåò': { 'üåò': 3, 'üåó': 3, 'üåñ': 3, 'üåï': 3, 'üåî': 4, 'üåì': 5, 'üåí': 6, 'üåë': -1 },
                    'üåó': { 'üåò': 2, 'üåó': 2, 'üåñ': 2, 'üåï': 2, 'üåî': 3, 'üåì': 4, 'üåí': 5, 'üåë': -1 },
                    'üåñ': { 'üåò': 1, 'üåó': 1, 'üåñ': 1, 'üåï': 1, 'üåî': 2, 'üåì': 3, 'üåí': 4, 'üåë': -1 },
                    'üåï': { 'üåò': 0, 'üåó': 0, 'üåñ': 0, 'üåï': 0, 'üåî': 1, 'üåì': 2, 'üåí': 3, 'üåë': -1 },
                    'üåî': { 'üåò': 0, 'üåó': 0, 'üåñ': 0, 'üåï': 0, 'üåî': 1, 'üåì': 2, 'üåí': 3, 'üåë': -1 },
                    'üåì': { 'üåò': 0, 'üåó': 0, 'üåñ': 0, 'üåï': 0, 'üåî': 1, 'üåì': 2, 'üåí': 3, 'üåë': -1 },
                    'üåí': { 'üåò': 0, 'üåó': 0, 'üåñ': 0, 'üåï': 0, 'üåî': 1, 'üåì': 2, 'üåí': 3, 'üåë': -1 }
                };
                
                return { ...map, ...distances };
            }
            
            // ËÆ°ÁÆó‰∏§‰∏™ÊúàÁõ∏‰πãÈó¥ÁöÑÁ©∫Áº∫Â∫¶
            getGapDistance(left, right) {
                return this.gapDistanceMap[left]?.[right] || 0;
            }
            
            // ÊâßË°åÁ≤òÂêàÊìç‰Ωú - Ê†πÊçÆÊúÄÂ∞ëÊõ¥Êç¢ÂéüÂàô
            performAdhesion(left, right) {
                const gap = this.getGapDistance(left, right);
                if (gap <= 0 || gap > this.adhesionCoefficient) {
                    return [left, right];
                }
                
                // Â∞ùËØïÂêÑÁßçÂ°´ÂÖÖÊñπÊ°àÔºåÈÄâÊã©Êõ¥Êç¢ÊúÄÂ∞ëÁöÑ
                const fillOptions = [
                    ['üåï', right], // Â∑¶ËæπÂèòÊª°Êúà
                    [left, 'üåï'],  // Âè≥ËæπÂèòÊª°Êúà
                    ['üåï', 'üåï']   // ‰∏§ËæπÈÉΩÂèòÊª°Êúà
                ];
                
                // ‰ºòÂÖàÈÄâÊã©Âè™ÊîπÂèò‰∏ÄËæπÁöÑÊñπÊ°à
                for (const [newLeft, newRight] of fillOptions) {
                    if (this.getGapDistance(newLeft, newRight) === 0) {
                        // Â¶ÇÊûúÂè™ÈúÄË¶ÅÊîπÂèò‰∏ÄËæπÔºå‰ºòÂÖàÈÄâÊã©
                        if (newLeft !== left && newRight === right) {
                            return [newLeft, newRight];
                        }
                        if (newLeft === left && newRight !== right) {
                            return [newLeft, newRight];
                        }
                    }
                }
                
                // Â¶ÇÊûúÂøÖÈ°ªÊîπÂèò‰∏§ËæπÔºåËøîÂõûÂèåÊª°Êúà
                return ['üåï', 'üåï'];
            }
            
            // Ëá™Á≤òÂêàÊìç‰Ωú
            selfAdhesion(lines) {
                const processedLines = [];
                
                for (let line of lines) {
                    if (line.length === 0) {
                        processedLines.push(line);
                        continue;
                    }
                    
                    const chars = Array.from(line);
                    const newChars = [...chars];
                    
                    for (let i = 0; i < chars.length; i++) {
                        const current = chars[i];
                        
                        // Ë∑≥ËøáüåïÂíåüåë
                        if (current === 'üåï' || current === 'üåë') {
                            continue;
                        }
                        
                        // Ê£ÄÊü•Â∑¶Âè≥‰∏§‰æßÊòØÂê¶ÈÉΩÊòØüåëÔºàÁ©∫Áº∫Â∫¶‰∏∫-1Ôºâ
                        let leftIsEmpty = false, rightIsEmpty = false;
                        
                        if (i === 0) {
                            leftIsEmpty = true; // ÊúÄÂ∑¶‰æßËßÜ‰∏∫-1
                        } else {
                            leftIsEmpty = (chars[i - 1] === 'üåë');
                        }
                        
                        if (i === chars.length - 1) {
                            rightIsEmpty = true; // ÊúÄÂè≥‰æßËßÜ‰∏∫-1
                        } else {
                            rightIsEmpty = (chars[i + 1] === 'üåë');
                        }
                        
                        // Â¶ÇÊûúÂ∑¶Âè≥‰∏§‰æßÈÉΩÊòØÁ©∫Áº∫Ôºà-1ÔºâÔºåÊâßË°åËá™Á≤òÂêàÊ£ÄÊü•
                        if (leftIsEmpty && rightIsEmpty) {
                            const selfGap = this.selfGapMap[current] || 0;
                            if (selfGap <= this.adhesionCoefficient) {
                                newChars[i] = 'üåï';
                            }
                        }
                    }
                    
                    processedLines.push(newChars.join(''));
                }
                
                return processedLines;
            }
            
            // ‰∏ªÂ§ÑÁêÜÂáΩÊï∞ - Ê®™ÂêëÂä†Âº∫
            enhance(moonArtText) {
                if (this.adhesionCoefficient === 0) {
                    return moonArtText;
                }
                
                const lines = moonArtText.split('\n');
                const processedLines = [];
                
                for (let line of lines) {
                    if (line.length === 0) {
                        processedLines.push(line);
                        continue;
                    }
                    
                    // Â∞ÜemojiÂ≠óÁ¨¶‰∏≤ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÔºàÂ§ÑÁêÜ2Â≠óËäÇemojiÔºâ
                    const chars = Array.from(line);
                    const newChars = [...chars];
                    
                    // ‰ªéÂ∑¶Âà∞Âè≥ÊâßË°åÁ≤òÂêàÊìç‰Ωú
                    for (let i = 0; i < chars.length - 1; i++) {
                        const [newLeft, newRight] = this.performAdhesion(newChars[i], newChars[i + 1]);
                        newChars[i] = newLeft;
                        newChars[i + 1] = newRight;
                    }
                    
                    processedLines.push(newChars.join(''));
                }
                
                // ÊâßË°åËá™Á≤òÂêàÊìç‰Ωú
                const selfAdhesedLines = this.selfAdhesion(processedLines);
                
                // Ê†πÊçÆÂºÄÂÖ≥ÂÜ≥ÂÆöÊòØÂê¶ÊâßË°åÂéªÂô™Êìç‰Ωú
                if (this.enableDenoising) {
                    return this.denoise(selfAdhesedLines);
                } else {
                    return selfAdhesedLines.join('\n');
                }
            }
            
            // ÂéªÂô™Êìç‰Ωú
            denoise(lines) {
                const denoiseLines = [];
                
                for (let line of lines) {
                    if (line.length === 0) {
                        denoiseLines.push(line);
                        continue;
                    }
                    
                    const chars = Array.from(line);
                    const newChars = [...chars];
                    
                    for (let i = 0; i < chars.length; i++) {
                        const current = chars[i];
                        if (current === 'üåë') continue;
                        
                        // Ê£ÄÊü•Â∑¶Âè≥‰∏§‰æßÁöÑÁ©∫Áº∫Â∫¶
                        let leftGap = -1, rightGap = -1;
                        
                        if (i > 0) {
                            leftGap = this.getGapDistance(chars[i - 1], current);
                        }
                        if (i < chars.length - 1) {
                            rightGap = this.getGapDistance(current, chars[i + 1]);
                        }
                        
                        // Â¶ÇÊûú‰∏§‰æßÁ©∫Áº∫Â∫¶ÈÉΩÊª°Ë∂≥ÔºàÂ§ß‰∫é0ÊàñÁ≠â‰∫é-1Ôºâ‰∏î‰∏çÊòØüåïÔºåËÆ§‰∏∫ÊòØÂô™ÁÇπ
                        if (current !== 'üåï' && 
                            (leftGap > 0 || leftGap === -1) && 
                            (rightGap > 0 || rightGap === -1)) {
                            newChars[i] = 'üåë';
                        }
                    }
                    
                    denoiseLines.push(newChars.join(''));
                }
                
                return denoiseLines.join('\n');
            }
        }
        
        class SimpleMoonGenerator {
            constructor() {
                // Âü∫Á°ÄÊúàÁõ∏Ê®°ÂºèÔºöÂü∫‰∫éÈªëËâ≤ÂÉèÁ¥†Êï∞ÈáèÁöÑÂàÜÂ∏É
                this.moonPhases = [
                    { emoji: 'üåë', minBlack: 0, maxBlack: 0 },    // ÂÖ®ÁôΩ/Á©∫
                    { emoji: 'üåò', minBlack: 1, maxBlack: 4 },    // ÂæàÂ∞ëÈªëËâ≤ 
                    { emoji: 'üåó', minBlack: 5, maxBlack: 8 },    // Â∞ëÈáèÈªëËâ≤
                    { emoji: 'üåñ', minBlack: 9, maxBlack: 12 },   // ‰∏≠Á≠âÈªëËâ≤
                    { emoji: 'üåï', minBlack: 13, maxBlack: 16 }   // Â§ßÈáèÈªëËâ≤
                ];
                
                // ÂûÇÁõ¥ÂåñÂ§ÑÁêÜËÆ∞ÂΩïÔºöÂ≠òÂÇ®Ë¢´Â§ÑÁêÜÂ≠óÁ¨¶ÁöÑ‰ΩçÁΩÆÂíåÂØÜÂ∫¶‰ø°ÊÅØ
                this.verticalProcessingPositions = [];
            }
            
            // ÊúÄÁÆÄÂçïÁöÑÁÅ∞Â∫¶ÂÄºËΩ¨Êç¢ÔºöÂè™ÊúâÈªëÁôΩ‰∏§Ëâ≤
            grayToColorLevel(gray) {
                return gray < 128 ? 0 : 1; // 0 = ÈªëËâ≤Ôºå1 = ÁôΩËâ≤
            }
            
            // Âü∫‰∫é5x5ÁΩëÊ†ºÁöÑÊñ∞ÂØÜÂ∫¶ÂàÜÁ∫ßÊúàÁõ∏ËΩ¨Êç¢Á≥ªÁªüÔºàÂ∏¶ÂÖÉÊï∞ÊçÆÔºâ
            gridToMoonWithMeta(grid) {
                // ÁªüËÆ°5x5ÁΩëÊ†º‰∏≠ÈªëËâ≤ÂÉèÁ¥†Ôºà0ÔºâÁöÑÊï∞Èáè
                let blackCount = 0;
                for (let y = 0; y < 5; y++) {
                    for (let x = 0; x < 5; x++) {
                        if (grid[y][x] === 0) { // 0 = ÈªëËâ≤
                            blackCount++;
                        }
                    }
                }
                
                // Ëé∑ÂèñÂØÜÂ∫¶Á≠âÁ∫ß‰ø°ÊÅØ
                const densityLevel = this.getDensityLevel(blackCount);
                
                // ËÆ°ÁÆóÊ∞¥Âπ≥ÈáçÂøÉÂíåÂÅèÂêë
                const centerX = this.calculateHorizontalCenter(grid);
                const bias = this.getBias(centerX);
                
                // Ê†πÊçÆÂØÜÂ∫¶Á≠âÁ∫ßÂíåÂÅèÂêëÈÄâÊã©ÂéüÂßãÊúàÁõ∏
                let originalMoonPhase;
                switch (densityLevel.name) {
                    case 'ÊûÅ‰ΩéÂØÜÂ∫¶':
                        originalMoonPhase = 'üåë';
                        break;
                    case 'È´òÂØÜÂ∫¶':
                        originalMoonPhase = 'üåï';
                        break;
                    case '‰∏≠‰ΩéÂØÜÂ∫¶':
                    case '‰∏≠Á≠âÂØÜÂ∫¶':
                    case 'Ê¨°È´òÂØÜÂ∫¶':
                        originalMoonPhase = this.selectMoonPhase(densityLevel.name, bias);
                        break;
                    default:
                        originalMoonPhase = 'üåë';
                }
                
                // ËøîÂõûÂÆåÊï¥ÁöÑÂÖÉÊï∞ÊçÆ
                return {
                    originalMoonPhase: originalMoonPhase,
                    finalMoonPhase: originalMoonPhase, // ÂàùÂßãÊó∂‰∏éÂéüÂßãÊúàÁõ∏Áõ∏Âêå
                    densityLevel: densityLevel.name,
                    densitySymbol: densityLevel.debugSymbol,
                    bias: bias,
                    blackCount: blackCount,
                    centerX: centerX
                };
            }
            
            // Âü∫‰∫é5x5ÁΩëÊ†ºÁöÑÊñ∞ÂØÜÂ∫¶ÂàÜÁ∫ßÊúàÁõ∏ËΩ¨Êç¢Á≥ªÁªüÔºàÂêëÂêéÂÖºÂÆπÔºâ
            gridToMoon(grid) {
                return this.gridToMoonWithMeta(grid).finalMoonPhase;
            }
            
            // Ëé∑ÂèñÂØÜÂ∫¶Á≠âÁ∫ß
            getDensityLevel(blackCount) {
                const densityLevels = [
                    { name: 'ÊûÅ‰ΩéÂØÜÂ∫¶', minPixels: 1, maxPixels: 4, debugSymbol: '‚¨õ' },
                    { name: '‰∏≠‰ΩéÂØÜÂ∫¶', minPixels: 5, maxPixels: 8, debugSymbol: 'üü¶' },
                    { name: '‰∏≠Á≠âÂØÜÂ∫¶', minPixels: 9, maxPixels: 14, debugSymbol: 'üüß' },
                    { name: 'Ê¨°È´òÂØÜÂ∫¶', minPixels: 15, maxPixels: 21, debugSymbol: 'üü®' },
                    { name: 'È´òÂØÜÂ∫¶', minPixels: 22, maxPixels: 25, debugSymbol: 'Êó†' }
                ];
                
                if (blackCount === 0) {
                    return { name: 'Á©∫ÁôΩ', debugSymbol: '‚¨ú' };
                }
                
                for (const level of densityLevels) {
                    if (blackCount >= level.minPixels && blackCount <= level.maxPixels) {
                        return level;
                    }
                }
                
                // Ë∂ÖÂá∫ËåÉÂõ¥ÔºåÈªòËÆ§‰∏∫È´òÂØÜÂ∫¶
                return densityLevels[4];
            }
            
            // ËÆ°ÁÆó5x5ÁΩëÊ†ºÁöÑÊ∞¥Âπ≥ÈáçÂøÉ
            calculateHorizontalCenter(grid) {
                let weightedX = 0;
                let totalBlack = 0;
                
                for (let y = 0; y < 5; y++) {
                    for (let x = 0; x < 5; x++) {
                        if (grid[y][x] === 0) { // 0 = ÈªëËâ≤
                            weightedX += x;
                            totalBlack++;
                        }
                    }
                }
                
                return totalBlack > 0 ? weightedX / totalBlack : 2; // 5x5‰∏≠ÂøÉ‰∏∫2
            }
            
            // Âà§Êñ≠ÈáçÂøÉÂÅèÂêë
            getBias(centerX) {
                if (centerX < 1.8) {
                    return 'left';
                } else if (centerX > 2.2) {
                    return 'right';
                } else {
                    return 'balanced';
                }
            }
            
            // Ê†πÊçÆÂØÜÂ∫¶Á≠âÁ∫ßÂíåÂÅèÂêëÈÄâÊã©ÊúàÁõ∏
            selectMoonPhase(densityLevel, bias) {
                const phaseMap = {
                    '‰∏≠‰ΩéÂØÜÂ∫¶': { left: 'üåò', right: 'üåí', balanced: 'üåï' },
                    '‰∏≠Á≠âÂØÜÂ∫¶': { left: 'üåó', right: 'üåì', balanced: 'üåï' },
                    'Ê¨°È´òÂØÜÂ∫¶': { left: 'üåñ', right: 'üåî', balanced: 'üåï' }
                };
                
                return phaseMap[densityLevel]?.[bias] || 'üåï';
            }
            
            // ÊúàÁõ∏ÂèçËâ≤Â§ÑÁêÜ
            reverseMoon(emoji) {
                const reverseMap = {
                    'üåë': 'üåï', // Êñ∞Êúà ‚Üî Êª°Êúà
                    'üåí': 'üåñ', // ËõæÊúà ‚Üî ‰∫èÊúà
                    'üåì': 'üåó', // ‰∏äÂº¶Êúà ‚Üî ‰∏ãÂº¶Êúà
                    'üåî': 'üåò', // Âá∏Êúà ‚Üî ÊÆãÊúà
                    'üåï': 'üåë', // Êª°Êúà ‚Üî Êñ∞Êúà
                    'üåñ': 'üåí', // ‰∫èÊúà ‚Üî ËõæÊúà
                    'üåó': 'üåì', // ‰∏ãÂº¶Êúà ‚Üî ‰∏äÂº¶Êúà
                    'üåò': 'üåî'  // ÊÆãÊúà ‚Üî Âá∏Êúà
                };
                return reverseMap[emoji] || emoji;
            }
            
            // ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÔºöÂ≠óÁ¨¶Á©∫Áº∫Â∫¶Êò†Â∞ÑË°®
            getCharacterVacancy(moonPhase) {
                // Â¢ûÂº∫ÁöÑÂ≠óÁ¨¶ËßÑËåÉÂåñÂ§ÑÁêÜ
                let normalizedPhase = moonPhase.normalize('NFC').replace(/[\uFE0E\uFE0F]/g, '').trim();
                
                // ‰ΩøÁî®Â≠óÁ¨¶Á†ÅÁÇπËøõË°åÁ≤æÁ°ÆÂåπÈÖç
                const vacancyMapByCodePoint = {
                    0x1F314: 1, // üåî
                    0x1F313: 2, // üåì  
                    0x1F312: 3, // üåí
                    0x1F311: 4, // üåë
                    0x1F318: 3, // üåò
                    0x1F317: 2, // üåó
                    0x1F316: 1, // üåñ
                    0x1F315: 0  // üåï
                };
                
                // ‰ºòÂÖà‰ΩøÁî®Á†ÅÁÇπÂåπÈÖç
                const codePoint = normalizedPhase.codePointAt(0);
                if (codePoint && vacancyMapByCodePoint.hasOwnProperty(codePoint)) {
                    return vacancyMapByCodePoint[codePoint];
                }
                
                // Â§áÁî®Â≠óÁ¨¶‰∏≤ÂåπÈÖç
                const vacancyMap = {
                    'üåî': 1, 'üåì': 2, 'üåí': 3, 'üåë': 4,
                    'üåò': 3, 'üåó': 2, 'üåñ': 1, 'üåï': 0
                };
                
                return vacancyMap[normalizedPhase] || 4; // ÈªòËÆ§‰∏∫ÊúÄÈ´òÁ©∫Áº∫Â∫¶
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂûÇÁõ¥ÂåñÂ§ÑÁêÜ
            shouldApplyVerticalProcessing(cellMeta, targetDensityLevels) {
                return targetDensityLevels.includes(cellMeta.densityLevel) && 
                       cellMeta.bias === 'balanced';
            }
            
            // ‰ªé‰∏äÂà∞‰∏ãËøõË°åÂûÇÁõ¥ÂåñÂ§ÑÁêÜ
            applyVerticalProcessing(gridWithMeta, targetDensityLevels, thresholdN = 2) {
                const gridHeight = gridWithMeta.length;
                const gridWidth = gridWithMeta[0]?.length || 0;
                
                // Ê∏ÖÁ©∫‰πãÂâçÁöÑËÆ∞ÂΩï
                this.verticalProcessingPositions = [];
                
                
                
                
                
                // ‰ªéÁ¨¨2Ë°åÂºÄÂßãÂ§ÑÁêÜÔºàÁ¨¨1Ë°åÊ≤°Êúâ‰∏äÊñπÂ≠óÁ¨¶Ôºâ
                for (let row = 1; row < gridHeight; row++) {
                    for (let col = 0; col < gridWidth; col++) {
                        const currentCell = gridWithMeta[row][col];
                        
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂûÇÁõ¥ÂåñÂ§ÑÁêÜ
                        if (this.shouldApplyVerticalProcessing(currentCell, targetDensityLevels)) {
                            
                            
                            // ËÆ∞ÂΩïË¢´ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÁöÑ‰ΩçÁΩÆÂíåÂØÜÂ∫¶‰ø°ÊÅØ
                            this.verticalProcessingPositions.push({
                                row: row,
                                col: col,
                                densityLevel: currentCell.densityLevel
                            });
                            
                            const aboveCell = gridWithMeta[row - 1][col];
                            const aboveVacancy = this.getCharacterVacancy(aboveCell.finalMoonPhase);
                            
                            
                            // Áªü‰∏Ä‰ΩøÁî®Á©∫Áº∫Â∫¶Âà§Êñ≠
                            if (aboveVacancy <= thresholdN) {
                                currentCell.finalMoonPhase = 'üåë';
                            } else {
                                currentCell.finalMoonPhase = 'üåï';
                            }
                            
                        }
                        // ‰∏çÈúÄË¶ÅÂûÇÁõ¥ÂåñÂ§ÑÁêÜÁöÑÂ≠óÁ¨¶‰øùÊåÅÂéüÊúâfinalMoonPhase‰∏çÂèò
                    }
                }
                
                
                return gridWithMeta;
            }
            
            // ÂØÜÂ∫¶Á≠âÁ∫ßË∞ÉËØïÁ¨¶Âè∑Êò†Â∞Ñ
            getDensityDebugSymbol(densityLevel) {
                const DENSITY_DEBUG_SYMBOLS = {
                    '‰∏≠Á≠âÂØÜÂ∫¶': 'üüß',  // Ê©ôËâ≤ÊñπÂùó
                    '‰∏≠‰ΩéÂØÜÂ∫¶': 'üü¶',  // ËìùËâ≤ÊñπÂùó  
                    'Ê¨°È´òÂØÜÂ∫¶': 'üü®',  // ÈªÑËâ≤ÊñπÂùó
                    'ÊûÅ‰ΩéÂØÜÂ∫¶': '‚¨õ',  // ÈªëËâ≤ÊñπÂùó
                    'È´òÂØÜÂ∫¶': 'üåï'     // ‰øùÊåÅÂéüÊ†∑
                };
                
                return DENSITY_DEBUG_SYMBOLS[densityLevel] || '‚ùì';
            }
            
            // Â∫îÁî®ÂûÇÁõ¥ÂåñË∞ÉËØïÁ¨¶Âè∑ÊòæÁ§∫
            applyVerticalDebugSymbols(resultText) {
                if (this.verticalProcessingPositions.length === 0) {
                    return resultText;
                }
                
                
                const lines = resultText.split('\n');
                const resultLines = [...lines];
                
                // ÈÅçÂéÜÊâÄÊúâË¢´ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÁöÑ‰ΩçÁΩÆÔºåÊõøÊç¢‰∏∫Ë∞ÉËØïÁ¨¶Âè∑ÔºàÊòæÁ§∫Â§ÑÁêÜÁä∂ÊÄÅÔºâ
                for (const position of this.verticalProcessingPositions) {
                    const { row, col, densityLevel } = position;
                    
                    if (row < resultLines.length) {
                        const line = resultLines[row];
                        if (col < line.length) {
                            const originalChar = Array.from(line)[col];
                            let debugSymbol;
                            
                            // Áªü‰∏Ä‰ΩøÁî®ÂØÜÂ∫¶Á¨¶Âè∑Ôºå‰∏çÂØπÂ§ÑÁêÜÁªìÊûúÂÅöÂå∫ÂàÜ
                            debugSymbol = this.getDensityDebugSymbol(densityLevel);
                            
                            
                            // ÊõøÊç¢ÊåáÂÆö‰ΩçÁΩÆÁöÑÂ≠óÁ¨¶
                            const chars = Array.from(line);
                            chars[col] = debugSymbol;
                            resultLines[row] = chars.join('');
                            
                            console.log(`Ë∞ÉËØïÁ¨¶Âè∑ÊõøÊç¢: ‰ΩçÁΩÆ(${row},${col}), ÂéüÂ≠óÁ¨¶=${originalChar}, ÂØÜÂ∫¶=${densityLevel} ‚Üí ${debugSymbol}`);
                        }
                    }
                }
                
                return resultLines.join('\n');
            }
            
            // Â∫îÁî®Â≠óÁ¨¶Èó¥Ë∑ù
            applySpacing(text, spacing) {
                if (spacing <= 0) return text;
                
                const lines = text.split('\n');
                const spacedLines = [];
                
                for (const line of lines) {
                    if (line.length === 0) {
                        spacedLines.push(line);
                        continue;
                    }
                    
                    // Âú®ÊØè‰∏™Â≠óÁ¨¶‰πãÈó¥ÊèíÂÖ•ÊåáÂÆöÊï∞ÈáèÁöÑüåëÔºàÁ©∫Ê†ºÔºâ
                    const chars = Array.from(line);
                    const spacedChars = [];
                    
                    for (let i = 0; i < chars.length; i++) {
                        spacedChars.push(chars[i]);
                        // Èô§‰∫ÜÊúÄÂêé‰∏Ä‰∏™Â≠óÁ¨¶ÔºåÊØè‰∏™Â≠óÁ¨¶ÂêéÈù¢ÈÉΩÊ∑ªÂä†Èó¥Ë∑ù
                        if (i < chars.length - 1) {
                            spacedChars.push('üåë'.repeat(spacing));
                        }
                    }
                    
                    spacedLines.push(spacedChars.join(''));
                }
                
                return spacedLines.join('\n');
            }
            
            // Â∫îÁî®ËæπË∑ùÔºàpaddingÔºâ
            applyPadding(text, padding) {
                if (padding <= 0) return text;
                
                const lines = text.split('\n');
                if (lines.length === 0) return text;
                
                // ËÆ°ÁÆóÊúÄÂ§ßË°åÂÆΩ
                const maxWidth = Math.max(...lines.map(line => Array.from(line).length));
                
                // ÂàõÂª∫ËæπË∑ùÂ≠óÁ¨¶ÔºàÈªëÊúàÔºâ
                const paddingChar = 'üåë';
                const horizontalPadding = paddingChar.repeat(padding);
                const fullPaddingLine = paddingChar.repeat(maxWidth + 2 * padding);
                
                const paddedLines = [];
                
                // Ê∑ªÂä†‰∏äËæπË∑ù
                for (let i = 0; i < padding; i++) {
                    paddedLines.push(fullPaddingLine);
                }
                
                // Ê∑ªÂä†Â∑¶Âè≥ËæπË∑ùÂà∞ÊØè‰∏ÄË°å
                for (const line of lines) {
                    const chars = Array.from(line);
                    // Â°´ÂÖÖË°åÂà∞ÊúÄÂ§ßÂÆΩÂ∫¶
                    while (chars.length < maxWidth) {
                        chars.push('üåë');
                    }
                    const paddedLine = horizontalPadding + chars.join('') + horizontalPadding;
                    paddedLines.push(paddedLine);
                }
                
                // Ê∑ªÂä†‰∏ãËæπË∑ù
                for (let i = 0; i < padding; i++) {
                    paddedLines.push(fullPaddingLine);
                }
                
                return paddedLines.join('\n');
            }
            
            // ‰ªéÂÉèÁ¥†Áü©ÈòµÁîüÊàêÊúàÊñáÂ≠óÔºàÁî®‰∫éÂõæÁâáËæìÂÖ•Ôºâ
            generateFromPixelMatrix(pixelMatrix, width, height, enableVerticalProcessing = true, showVerticalDebug = false, padding = 0) {
                console.log(`‰ªéÂÉèÁ¥†Áü©ÈòµÁîüÊàêÊúàÊñáÂ≠ó: ${width}x${height}ÂÉèÁ¥†`);
                
                // Ê∏ÖÁ©∫ÂûÇÁõ¥ÂåñÂ§ÑÁêÜËÆ∞ÂΩï
                this.verticalProcessingPositions = [];
                
                // ÂàõÂª∫ÂÖÉÊï∞ÊçÆÁΩëÊ†º
                const metaGrid = [];
                const gridSize = 5;
                
                // Êåâ5x5ÁΩëÊ†ºÊâ´ÊèèÂÉèÁ¥†Áü©Èòµ
                for (let y = 0; y < height; y += gridSize) {
                    const metaRow = [];
                    for (let x = 0; x < width; x += gridSize) {
                        // ÊèêÂèñ5x5Â≠êÁΩëÊ†º
                        const subGrid = [];
                        for (let dy = 0; dy < gridSize; dy++) {
                            subGrid[dy] = [];
                            for (let dx = 0; dx < gridSize; dx++) {
                                const py = y + dy;
                                const px = x + dx;
                                // ËæπÁïåÊ£ÄÊü•
                                if (py < height && px < width) {
                                    subGrid[dy][dx] = pixelMatrix[py][px];
                                } else {
                                    subGrid[dy][dx] = 1; // Ë∂ÖÂá∫ËæπÁïåÈªòËÆ§‰∏∫ÁôΩËâ≤
                                }
                            }
                        }
                        
                        // Â∞Ü5x5ÁΩëÊ†ºËΩ¨Êç¢‰∏∫Â∏¶ÂÖÉÊï∞ÊçÆÁöÑÊúàÁõ∏
                        const cellMeta = this.gridToMoonWithMeta(subGrid);
                        metaRow.push(cellMeta);
                    }
                    if (metaRow.length > 0) {
                        metaGrid.push(metaRow);
                    }
                }
                
                console.log(`ÂÖÉÊï∞ÊçÆÁΩëÊ†ºÁîüÊàêÂÆåÊàê: ${metaGrid[0]?.length || 0}Âàó x ${metaGrid.length}Ë°å`);
                
                // Â∫îÁî®ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÔºàÂ¶ÇÊûúÂêØÁî®Ôºâ
                if (enableVerticalProcessing) {
                    // ‰ªéUIËé∑ÂèñÂûÇÁõ¥ÂåñÂ§ÑÁêÜËÆæÁΩÆ
                    const targetDensityLevels = [];
                    if (document.getElementById('verticalMedium').checked) {
                        targetDensityLevels.push('‰∏≠Á≠âÂØÜÂ∫¶');
                    }
                    if (document.getElementById('verticalHigh').checked) {
                        targetDensityLevels.push('Ê¨°È´òÂØÜÂ∫¶');
                    }
                    const thresholdN = 2; // ÈªòËÆ§ÈòàÂÄº
                    
                    this.applyVerticalProcessing(metaGrid, targetDensityLevels, thresholdN);
                    console.log(`ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÂÆåÊàêÔºåÂ§ÑÁêÜ‰∫Ü${this.verticalProcessingPositions.length}‰∏™‰ΩçÁΩÆ`);
                }
                
                // ‰ªéÂÖÉÊï∞ÊçÆÁΩëÊ†ºÊèêÂèñÊúÄÁªàÊúàÁõ∏
                const resultLines = metaGrid.map(row => 
                    row.map(cell => cell.finalMoonPhase).join('')
                );
                
                let result = resultLines.join('\n');
                
                // Â∫îÁî®ÂûÇÁõ¥ÂåñË∞ÉËØïÁ¨¶Âè∑ÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
                if (showVerticalDebug) {
                    result = this.applyVerticalDebugSymbols(result);
                    console.log(`ÂûÇÁõ¥ÂåñË∞ÉËØïÁ¨¶Âè∑Â∑≤Â∫îÁî®`);
                }
                
                // Â∫îÁî®ËæπË∑ù
                if (padding > 0) {
                    result = this.applyPadding(result, padding);
                    console.log(`ËæπË∑ùÂ∫îÁî®ÂÆåÊàêÔºåËæπË∑ùÂÆΩÂ∫¶: ${padding}`);
                }
                
                return result;
            }
            
            // ‰∏ìÈó®Áî®‰∫éÂõæÁâáÁöÑÁÆÄÂåñÂ§ÑÁêÜÊµÅÁ®ãÔºàË∑≥ËøáÊñáÂ≠ó‰ºòÂåñÁÆóÊ≥ïÔºâ
            generateFromImage(pixelMatrix, width, height, padding = 0) {
                console.log(`ÂõæÁâáÁõ¥Êé•Â§ÑÁêÜÊ®°Âºè: ${width}x${height}ÂÉèÁ¥†`);
                
                const metaGrid = [];
                const gridSize = 5;
                
                // Êåâ5x5ÁΩëÊ†ºÊâ´ÊèèÂÉèÁ¥†Áü©Èòµ
                for (let y = 0; y < height; y += gridSize) {
                    const metaRow = [];
                    for (let x = 0; x < width; x += gridSize) {
                        // ÊèêÂèñ5x5Â≠êÁΩëÊ†º
                        const subGrid = [];
                        for (let dy = 0; dy < gridSize; dy++) {
                            subGrid[dy] = [];
                            for (let dx = 0; dx < gridSize; dx++) {
                                const py = y + dy;
                                const px = x + dx;
                                if (py < height && px < width) {
                                    subGrid[dy][dx] = pixelMatrix[py][px];
                                } else {
                                    subGrid[dy][dx] = 1; // Ë∂ÖÂá∫ËæπÁïåÈªòËÆ§‰∏∫ÁôΩËâ≤
                                }
                            }
                        }
                        
                        // Áõ¥Êé•ËΩ¨Êç¢‰∏∫ÊúàÁõ∏Ôºà‰ΩøÁî®‰∏ìÈó®ÁöÑÂõæÁâáÊò†Â∞ÑÈÄªËæëÔºâ
                        const moonPhase = this.gridToMoonForImage(subGrid);
                        metaRow.push(moonPhase);
                    }
                    if (metaRow.length > 0) {
                        metaGrid.push(metaRow);
                    }
                }
                
                // Áõ¥Êé•ÁîüÊàêÁªìÊûúÂ≠óÁ¨¶‰∏≤
                const resultLines = metaGrid.map(row => row.join(''));
                let result = resultLines.join('\n');
                
                // ‰ªÖÂ∫îÁî®ËæπË∑ùÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
                if (padding > 0) {
                    result = this.applyPadding(result, padding);
                }
                
                console.log(`ÂõæÁâáÂ§ÑÁêÜÂÆåÊàê: ËæìÂá∫${metaGrid.length}Ë°å`);
                return result;
            }
            
            // ‰∏ìÈó®Áî®‰∫éÂõæÁâáÁöÑ5x5ÁΩëÊ†ºÂà∞ÊúàÁõ∏Êò†Â∞ÑÔºà8Á∫ßÁÅ∞Â∫¶Ôºâ
            gridToMoonForImage(grid) {
                // ÁªüËÆ°ÈªëËâ≤ÂÉèÁ¥†Êï∞Èáè
                let blackCount = 0;
                for (let y = 0; y < 5; y++) {
                    for (let x = 0; x < 5; x++) {
                        if (grid[y][x] === 0) {
                            blackCount++;
                        }
                    }
                }
                
                // Êõ¥Á≤æÁªÜÁöÑÁÅ∞Â∫¶Á∫ßÂà´Êò†Â∞ÑÔºà8‰∏™ÊúàÁõ∏ÂØπÂ∫î‰∏çÂêåÂØÜÂ∫¶Ôºâ
                // 0-25‰∏™ÈªëÁÇπÊò†Â∞ÑÂà∞ÊúàÁõ∏
                const ratio = blackCount / 25;
                
                // Ê†πÊçÆÈªëËâ≤ÂÉèÁ¥†ÊØî‰æãËøîÂõûÂØπÂ∫îÊúàÁõ∏
                // Ê≥®ÊÑèÔºöËøôÈáåÁöÑÊò†Â∞ÑÊòØÂü∫‰∫éËßÜËßâÂØÜÂ∫¶ÔºåÈªëËâ≤Ë∂äÂ§öÊúàÁõ∏Ë∂ä"Êª°"
                if (ratio === 0) return 'üåë';        // 0% - ÂÖ®ÁôΩËÉåÊôØ
                else if (ratio <= 0.125) return 'üåò'; // 0-12.5% - ÊûÅÂ∞ëÈªëËâ≤
                else if (ratio <= 0.25) return 'üåó';  // 12.5-25% - Â∞ëÈáèÈªëËâ≤
                else if (ratio <= 0.375) return 'üåñ'; // 25-37.5% - ËæÉÂ∞ëÈªëËâ≤
                else if (ratio <= 0.5) return 'üåï';   // 37.5-50% - ‰∏≠Á≠âÈªëËâ≤
                else if (ratio <= 0.625) return 'üåî'; // 50-62.5% - ËæÉÂ§öÈªëËâ≤
                else if (ratio <= 0.75) return 'üåì';  // 62.5-75% - Â§ßÈáèÈªëËâ≤
                else if (ratio <= 0.875) return 'üåí'; // 75-87.5% - ÊûÅÂ§öÈªëËâ≤
                else return 'üåë';                     // 87.5-100% - Âá†‰πéÂÖ®Èªë
            }
            
            // ÁîüÊàêÂçï‰∏™Â≠óÁ¨¶ÁöÑÊúàÁõ∏
            generateSingleChar(char, sizeParam = 20, fontType = 'custom', isVertical = true) {
                if (!char.trim()) return [];
                
                const fontFamily = FONT_FAMILIES[fontType] || FONT_FAMILIES['default'];
                
                // Á¨¨‰∏ÄÈò∂ÊÆµÔºöÂàõÂª∫Ë∂≥Â§üÂ§ßÁöÑcanvasÊù•ÂÆåÊï¥Ê∏≤ÊüìÂ≠óÁ¨¶
                const baseFontSize = Math.max(sizeParam * 5, 50); // Á°Æ‰øùÂ≠óÁ¨¶Ë∂≥Â§üÂ§ßÔºà5x5Á≥ªÁªüÔºâ
                const canvasWidth = baseFontSize * 2;   // ÁªôÂ≠óÁ¨¶Ë∂≥Â§üÁöÑÂÆΩÂ∫¶Á©∫Èó¥
                const canvasHeight = baseFontSize * 2;  // ÁªôÂ≠óÁ¨¶Ë∂≥Â§üÁöÑÈ´òÂ∫¶Á©∫Èó¥
                
                const canvas = document.createElement('canvas');
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                
                const ctx = canvas.getContext('2d');
                
                // ÁªòÂà∂ÁôΩËâ≤ËÉåÊôØ
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ÁªòÂà∂ÈªëËâ≤Â≠óÁ¨¶
                ctx.fillStyle = 'black';
                ctx.font = `bold ${baseFontSize}px ${fontFamily}`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const x = canvas.width / 2;
                const y = canvas.height / 2;
                ctx.fillText(char, x, y);
                
                console.log(`Â≠óÁ¨¶ "${char}" Ê∏≤Êüì: canvas=${canvasWidth}x${canvasHeight}, fontSize=${baseFontSize}`);
                
                // Ëé∑ÂèñÂõæÂÉèÊï∞ÊçÆÂπ∂ËΩ¨Êç¢‰∏∫ÂÉèÁ¥†Áü©Èòµ
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixelMatrix = [];
                
                for (let y = 0; y < canvas.height; y++) {
                    pixelMatrix[y] = [];
                    for (let x = 0; x < canvas.width; x++) {
                        const idx = (y * canvas.width + x) * 4;
                        const gray = 0.299 * imageData.data[idx] + 
                                   0.587 * imageData.data[idx + 1] + 
                                   0.114 * imageData.data[idx + 2];
                        pixelMatrix[y][x] = this.grayToColorLevel(gray);
                    }
                }
                
                // ÊâæÂà∞Â≠óÁ¨¶ÁöÑÂÆûÈôÖËæπÁïå
                let minX = canvas.width, maxX = 0, minY = canvas.height, maxY = 0;
                let foundText = false;
                
                for (let y = 0; y < canvas.height; y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        if (pixelMatrix[y][x] === 0) {
                            minX = Math.min(minX, x);
                            maxX = Math.max(maxX, x);
                            minY = Math.min(minY, y);
                            maxY = Math.max(maxY, y);
                            foundText = true;
                        }
                    }
                }
                
                if (!foundText) {
                    // Â¶ÇÊûúÊ≤°ÊâæÂà∞ÊñáÂ≠óÔºåËøîÂõûÊåâÁõÆÊ†áÂ∞∫ÂØ∏ÁöÑÈªòËÆ§Áü©ÂΩ¢
                    if (isVertical) {
                        // Á´ñÂêëÔºöÂõ∫ÂÆöÂÆΩÂ∫¶sizeParamÔºåÈªòËÆ§È´òÂ∫¶3
                        const defaultLine = 'üåï'.repeat(sizeParam);
                        return [defaultLine, defaultLine, defaultLine];
                    } else {
                        // Ê®™ÂêëÔºöÂõ∫ÂÆöÈ´òÂ∫¶sizeParamÔºåÈªòËÆ§ÂÆΩÂ∫¶3
                        const result = [];
                        for (let i = 0; i < sizeParam; i++) {
                            result.push('üåïüåïüåï');
                        }
                        return result;
                    }
                }
                
                // Á¨¨‰∫åÈò∂ÊÆµÔºöÂ∞ÜÂ≠óÁ¨¶ËæπÁïåÊò†Â∞ÑÂà∞ÁõÆÊ†áÂ∞∫ÂØ∏
                const charWidth = maxX - minX + 1;
                const charHeight = maxY - minY + 1;
                
                let targetPixelWidth, targetPixelHeight;
                if (isVertical) {
                    // Á´ñÂêëÔºöÂõ∫ÂÆöÂÆΩÂ∫¶‰∏∫sizeParam*5ÂÉèÁ¥†ÔºåÈ´òÂ∫¶ÊåâÊØî‰æãÁº©ÊîæÔºà5x5Á≥ªÁªüÔºâ
                    targetPixelWidth = sizeParam * 5;
                    targetPixelHeight = Math.ceil((charHeight * targetPixelWidth) / charWidth);
                    // Á°Æ‰øùÈ´òÂ∫¶ÊòØ5ÁöÑÂÄçÊï∞
                    targetPixelHeight = Math.ceil(targetPixelHeight / 5) * 5;
                } else {
                    // Ê®™ÂêëÔºöÂõ∫ÂÆöÈ´òÂ∫¶‰∏∫sizeParam*5ÂÉèÁ¥†ÔºåÂÆΩÂ∫¶ÊåâÊØî‰æãÁº©ÊîæÔºà5x5Á≥ªÁªüÔºâ
                    targetPixelHeight = sizeParam * 5;
                    targetPixelWidth = Math.ceil((charWidth * targetPixelHeight) / charHeight);
                    // Á°Æ‰øùÂÆΩÂ∫¶ÊòØ5ÁöÑÂÄçÊï∞
                    targetPixelWidth = Math.ceil(targetPixelWidth / 5) * 5;
                }
                
                console.log(`Â≠óÁ¨¶ "${char}" ËæπÁïå: ${charWidth}x${charHeight} ‚Üí ÁõÆÊ†á: ${targetPixelWidth}x${targetPixelHeight}`);
                
                // Á¨¨‰∏âÈò∂ÊÆµÔºöÊåâÁõÆÊ†áÂ∞∫ÂØ∏ËøõË°å5x5ÁΩëÊ†ºÊâ´Êèè
                const gridSize = 5;
                const resultLines = [];
                
                for (let targetY = 0; targetY < targetPixelHeight; targetY += gridSize) {
                    let line = '';
                    for (let targetX = 0; targetX < targetPixelWidth; targetX += gridSize) {
                        // ÊèêÂèñ5x5Â≠êÁΩëÊ†º
                        const subGrid = [];
                        for (let dy = 0; dy < 5; dy++) {
                            subGrid[dy] = [];
                            for (let dx = 0; dx < 5; dx++) {
                                // Â∞ÜÁõÆÊ†áÂùêÊ†áÊò†Â∞ÑÂõûÂéüÂßãÂ≠óÁ¨¶ÂùêÊ†á
                                const sourceX = minX + Math.round((targetX + dx) * charWidth / targetPixelWidth);
                                const sourceY = minY + Math.round((targetY + dy) * charHeight / targetPixelHeight);
                                
                                if (sourceY >= 0 && sourceY < canvas.height && sourceX >= 0 && sourceX < canvas.width) {
                                    subGrid[dy][dx] = pixelMatrix[sourceY][sourceX];
                                } else {
                                    subGrid[dy][dx] = 1; // ÁôΩËâ≤
                                }
                            }
                        }
                        
                        line += this.gridToMoon(subGrid);
                    }
                    resultLines.push(line);
                }
                
                console.log(`Â≠óÁ¨¶ "${char}" ËæìÂá∫: ${resultLines[0]?.length || 0}Âàó x ${resultLines.length}Ë°å`);
                
                return resultLines;
            }
            
            // ÂûÇÁõ¥ÊãºÊé•Â≠óÁ¨¶ÁªìÊûúÔºàÁ´ñÂêëÊéíÁâàÔºâ- Â≠óÁ¨¶‰ªé‰∏äÂà∞‰∏ãÊéíÂàó
            combineVertically(charResults, spacing, sizeParam) {
                if (charResults.length === 0) return '';
                
                let combinedLines = [];
                
                for (let i = 0; i < charResults.length; i++) {
                    const charLines = charResults[i];
                    
                    // Ê∑ªÂä†ÂΩìÂâçÂ≠óÁ¨¶ÁöÑÊâÄÊúâË°å
                    combinedLines.push(...charLines);
                    
                    // Â¶ÇÊûú‰∏çÊòØÊúÄÂêé‰∏Ä‰∏™Â≠óÁ¨¶ÔºåÊ∑ªÂä†Èó¥Ë∑ùË°åÔºàÊ∞¥Âπ≥ÂàÜÈöîÔºâ
                    if (i < charResults.length - 1 && spacing > 0) {
                        // ‰ΩøÁî®ÁõÆÊ†áÂÆΩÂ∫¶sizeParam‰Ωú‰∏∫Èó¥Ë∑ùË°åÂÆΩÂ∫¶ÔºåÁ°Æ‰øù‰∏éÂ≠óÁ¨¶ÂÆΩÂ∫¶‰∏ÄËá¥
                        const spacingLine = 'üåë'.repeat(sizeParam || 10);
                        
                        // Ê∑ªÂä†ÊåáÂÆöÊï∞ÈáèÁöÑÈó¥Ë∑ùË°å
                        for (let j = 0; j < spacing; j++) {
                            combinedLines.push(spacingLine);
                        }
                    }
                }
                
                return combinedLines.join('\n');
            }
            
            // Ê∞¥Âπ≥ÊãºÊé•Â≠óÁ¨¶ÁªìÊûúÔºàÊ®™ÂêëÊéíÁâàÔºâ
            combineHorizontally(charResults, spacing, sizeParam) {
                if (charResults.length === 0) return '';
                
                // ÊâæÂá∫ÊúÄÂ§ßË°åÊï∞ÔºåÁ°Æ‰øùÊâÄÊúâÂ≠óÁ¨¶ÁªìÊûúÂØπÈΩê
                const maxLines = Math.max(...charResults.map(result => result.length));
                
                // Ê†áÂáÜÂåñÊâÄÊúâÂ≠óÁ¨¶ÁªìÊûúÔºåÁ°Æ‰øùË°åÊï∞Áõ∏Á≠â
                const normalizedResults = charResults.map(result => {
                    const normalized = [...result];
                    // Ê®™ÂêëÊéíÁâàÊó∂Ôºå‰ΩøÁî®ÁõÆÊ†áÂÆΩÂ∫¶sizeParamÁ°Æ‰øùÂ°´ÂÖÖË°åÂÆΩÂ∫¶‰∏ÄËá¥
                    const emptyLine = 'üåë'.repeat(sizeParam || 10);
                    
                    // Áî®Á©∫Ë°åÂ°´ÂÖÖÂà∞ÊúÄÂ§ßË°åÊï∞
                    while (normalized.length < maxLines) {
                        normalized.push(emptyLine);
                    }
                    
                    return normalized;
                });
                
                const finalLines = [];
                
                // ÈÄêË°åÊãºÊé•
                for (let lineIndex = 0; lineIndex < maxLines; lineIndex++) {
                    let combinedLine = '';
                    
                    for (let charIndex = 0; charIndex < normalizedResults.length; charIndex++) {
                        combinedLine += normalizedResults[charIndex][lineIndex];
                        
                        // Â¶ÇÊûú‰∏çÊòØÊúÄÂêé‰∏Ä‰∏™Â≠óÁ¨¶ÔºåÊ∑ªÂä†Èó¥Ë∑ùÂàó
                        if (charIndex < normalizedResults.length - 1 && spacing > 0) {
                            combinedLine += 'üåë'.repeat(spacing);
                        }
                    }
                    
                    finalLines.push(combinedLine);
                }
                
                return finalLines.join('\n');
            }
            
            // ÁîüÊàêÂ∏¶ÂÖÉÊï∞ÊçÆÁöÑÂçï‰∏™Â≠óÁ¨¶
            generateSingleCharWithMeta(char, sizeParam = 20, fontType = 'custom', isVertical = true) {
                if (!char.trim()) return [];
                
                const fontFamily = FONT_FAMILIES[fontType] || FONT_FAMILIES['default'];
                
                // Á¨¨‰∏ÄÈò∂ÊÆµÔºöÂàõÂª∫Ë∂≥Â§üÂ§ßÁöÑcanvasÊù•ÂÆåÊï¥Ê∏≤ÊüìÂ≠óÁ¨¶
                const baseFontSize = Math.max(sizeParam * 5, 50);
                const canvasWidth = baseFontSize * 2;
                const canvasHeight = baseFontSize * 2;
                
                const canvas = document.createElement('canvas');
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                
                const ctx = canvas.getContext('2d');
                
                // ÁªòÂà∂ÁôΩËâ≤ËÉåÊôØ
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ÁªòÂà∂ÈªëËâ≤Â≠óÁ¨¶
                ctx.fillStyle = 'black';
                ctx.font = `bold ${baseFontSize}px ${fontFamily}`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const x = canvas.width / 2;
                const y = canvas.height / 2;
                ctx.fillText(char, x, y);
                
                console.log(`Â≠óÁ¨¶ "${char}" Ê∏≤Êüì: canvas=${canvasWidth}x${canvasHeight}, fontSize=${baseFontSize}`);
                
                // Ëé∑ÂèñÂõæÂÉèÊï∞ÊçÆÂπ∂ËΩ¨Êç¢‰∏∫ÂÉèÁ¥†Áü©Èòµ
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixelMatrix = [];
                
                for (let y = 0; y < canvas.height; y++) {
                    pixelMatrix[y] = [];
                    for (let x = 0; x < canvas.width; x++) {
                        const idx = (y * canvas.width + x) * 4;
                        const gray = 0.299 * imageData.data[idx] + 
                                   0.587 * imageData.data[idx + 1] + 
                                   0.114 * imageData.data[idx + 2];
                        pixelMatrix[y][x] = this.grayToColorLevel(gray);
                    }
                }
                
                // ÊâæÂà∞Â≠óÁ¨¶ÁöÑÂÆûÈôÖËæπÁïå
                let minX = canvas.width, maxX = 0, minY = canvas.height, maxY = 0;
                let foundText = false;
                
                for (let y = 0; y < canvas.height; y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        if (pixelMatrix[y][x] === 0) {
                            minX = Math.min(minX, x);
                            maxX = Math.max(maxX, x);
                            minY = Math.min(minY, y);
                            maxY = Math.max(maxY, y);
                            foundText = true;
                        }
                    }
                }
                
                if (!foundText) {
                    // Â¶ÇÊûúÊ≤°ÊâæÂà∞ÊñáÂ≠óÔºåËøîÂõûÊåâÁõÆÊ†áÂ∞∫ÂØ∏ÁöÑÈªòËÆ§Áü©ÂΩ¢ÂÖÉÊï∞ÊçÆ
                    const defaultSize = isVertical ? [sizeParam, 3] : [3, sizeParam];
                    const defaultGrid = [];
                    for (let row = 0; row < defaultSize[1]; row++) {
                        defaultGrid[row] = [];
                        for (let col = 0; col < defaultSize[0]; col++) {
                            defaultGrid[row][col] = this.gridToMoonWithMeta(Array(5).fill().map(() => Array(5).fill(0)));
                        }
                    }
                    return defaultGrid;
                }
                
                // Á¨¨‰∫åÈò∂ÊÆµÔºöÂ∞ÜÂ≠óÁ¨¶ËæπÁïåÊò†Â∞ÑÂà∞ÁõÆÊ†áÂ∞∫ÂØ∏
                const charWidth = maxX - minX + 1;
                const charHeight = maxY - minY + 1;
                
                let targetPixelWidth, targetPixelHeight;
                if (isVertical) {
                    targetPixelWidth = sizeParam * 5;
                    targetPixelHeight = Math.ceil((charHeight * targetPixelWidth) / charWidth);
                    targetPixelHeight = Math.ceil(targetPixelHeight / 5) * 5;
                } else {
                    targetPixelHeight = sizeParam * 5;
                    targetPixelWidth = Math.ceil((charWidth * targetPixelHeight) / charHeight);
                    targetPixelWidth = Math.ceil(targetPixelWidth / 5) * 5;
                }
                
                console.log(`Â≠óÁ¨¶ "${char}" ËæπÁïå: ${charWidth}x${charHeight} ‚Üí ÁõÆÊ†á: ${targetPixelWidth}x${targetPixelHeight}`);
                
                // Á¨¨‰∏âÈò∂ÊÆµÔºöÊåâÁõÆÊ†áÂ∞∫ÂØ∏ËøõË°å5x5ÁΩëÊ†ºÊâ´ÊèèÂπ∂ÁîüÊàêÂÖÉÊï∞ÊçÆ
                const gridSize = 5;
                const metaGrid = [];
                
                for (let targetY = 0; targetY < targetPixelHeight; targetY += gridSize) {
                    const metaRow = [];
                    for (let targetX = 0; targetX < targetPixelWidth; targetX += gridSize) {
                        // ÊèêÂèñ5x5Â≠êÁΩëÊ†º
                        const subGrid = [];
                        for (let dy = 0; dy < 5; dy++) {
                            subGrid[dy] = [];
                            for (let dx = 0; dx < 5; dx++) {
                                const sourceX = minX + Math.round((targetX + dx) * charWidth / targetPixelWidth);
                                const sourceY = minY + Math.round((targetY + dy) * charHeight / targetPixelHeight);
                                
                                if (sourceY >= 0 && sourceY < canvas.height && sourceX >= 0 && sourceX < canvas.width) {
                                    subGrid[dy][dx] = pixelMatrix[sourceY][sourceX];
                                } else {
                                    subGrid[dy][dx] = 1; // ÁôΩËâ≤
                                }
                            }
                        }
                        
                        metaRow.push(this.gridToMoonWithMeta(subGrid));
                    }
                    metaGrid.push(metaRow);
                }
                
                console.log(`Â≠óÁ¨¶ "${char}" ÂÖÉÊï∞ÊçÆËæìÂá∫: ${metaGrid[0]?.length || 0}Âàó x ${metaGrid.length}Ë°å`);
                
                return metaGrid;
            }

            // ÁîüÊàêÊúàÊñáÂ≠óÔºà‰ΩøÁî®ÂçïÂ≠óÁ¨¶Â§ÑÁêÜÊû∂ÊûÑÔºåÊîØÊåÅÂûÇÁõ¥ÂåñÂ§ÑÁêÜÔºâ
            generate(text, sizeParam = 20, fontType = 'custom', isVertical = true, reverseColor = false, spacing = 0, enableVerticalProcessing = true, showVerticalDebug = false, padding = 0) {
                if (!text.trim()) return '';
                
                console.log(`ÂçïÂ≠óÁ¨¶Â§ÑÁêÜÊû∂ÊûÑ: text="${text}", sizeParam=${sizeParam}, isVertical=${isVertical}, spacing=${spacing}`);
                console.log(`ÊéíÁâàÊñπÂêëÁ°ÆËÆ§: ${isVertical ? 'Á´ñÂêëÊéíÁâàÔºàÂ≠óÁ¨¶ÂûÇÁõ¥ÊéíÂàóÔºâ' : 'Ê®™ÂêëÊéíÁâàÔºàÂ≠óÁ¨¶Ê∞¥Âπ≥ÊéíÂàóÔºâ'}`);
                console.log(`ÂûÇÁõ¥ÂåñÂ§ÑÁêÜ: ${enableVerticalProcessing ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}`);
                
                // Â∞ÜÊñáÊú¨ÊãÜÂàÜ‰∏∫Â≠óÁ¨¶Êï∞ÁªÑ
                const chars = Array.from(text);
                
                if (enableVerticalProcessing) {
                    // ‰∏∫ÊØè‰∏™Â≠óÁ¨¶ÁîüÊàêÂ∏¶ÂÖÉÊï∞ÊçÆÁöÑÁªìÊûú
                    const charMetaResults = chars.map(char => {
                        return this.generateSingleCharWithMeta(char, sizeParam, fontType, isVertical);
                    });
                    
                    // ÂàõÂª∫ÂÖ®Â±ÄÂÖÉÊï∞ÊçÆÁΩëÊ†ºÁî®‰∫éÂûÇÁõ¥ÂåñÂ§ÑÁêÜ
                    let globalMetaGrid = [];
                    let maxCharWidth = 0;
                    
                    if (isVertical) {
                        // Á´ñÂêëÊéíÁâàÔºöÂ≠óÁ¨¶‰ªé‰∏äÂà∞‰∏ãÊéíÂàó
                        for (let charIndex = 0; charIndex < charMetaResults.length; charIndex++) {
                            const charMeta = charMetaResults[charIndex];
                            maxCharWidth = Math.max(maxCharWidth, charMeta[0]?.length || 0);
                            
                            // Ê∑ªÂä†ÂΩìÂâçÂ≠óÁ¨¶ÁöÑÊâÄÊúâË°åÂà∞ÂÖ®Â±ÄÁΩëÊ†º
                            globalMetaGrid.push(...charMeta);
                            
                            // Â¶ÇÊûú‰∏çÊòØÊúÄÂêé‰∏Ä‰∏™Â≠óÁ¨¶‰∏îÈúÄË¶ÅÈó¥Ë∑ùÔºåÊ∑ªÂä†Èó¥Ë∑ùË°å
                            if (charIndex < charMetaResults.length - 1 && spacing > 0) {
                                for (let s = 0; s < spacing; s++) {
                                    const spacingRow = [];
                                    for (let col = 0; col < (charMeta[0]?.length || sizeParam); col++) {
                                        spacingRow.push({
                                            originalMoonPhase: 'üåë',
                                            finalMoonPhase: 'üåë',
                                            densityLevel: 'ÊûÅ‰ΩéÂØÜÂ∫¶',
                                            densitySymbol: '‚¨õ',
                                            bias: 'balanced',
                                            blackCount: 0,
                                            centerX: 2
                                        });
                                    }
                                    globalMetaGrid.push(spacingRow);
                                }
                            }
                        }
                    } else {
                        // Ê®™ÂêëÊéíÁâàÔºöÂ≠óÁ¨¶‰ªéÂ∑¶Âà∞Âè≥ÊéíÂàó
                        const maxLines = Math.max(...charMetaResults.map(result => result.length));
                        
                        // Ê†áÂáÜÂåñÊâÄÊúâÂ≠óÁ¨¶ÁªìÊûúÁöÑË°åÊï∞
                        const normalizedResults = charMetaResults.map(result => {
                            const normalized = [...result];
                            const charWidth = result[0]?.length || sizeParam;
                            
                            while (normalized.length < maxLines) {
                                const emptyRow = [];
                                for (let col = 0; col < charWidth; col++) {
                                    emptyRow.push({
                                        originalMoonPhase: 'üåë',
                                        finalMoonPhase: 'üåë',
                                        densityLevel: 'ÊûÅ‰ΩéÂØÜÂ∫¶',
                                        densitySymbol: '‚¨õ',
                                        bias: 'balanced',
                                        blackCount: 0,
                                        centerX: 2
                                    });
                                }
                                normalized.push(emptyRow);
                            }
                            
                            return normalized;
                        });
                        
                        // ÈÄêË°åÊãºÊé•ÊâÄÊúâÂ≠óÁ¨¶
                        for (let lineIndex = 0; lineIndex < maxLines; lineIndex++) {
                            const combinedRow = [];
                            
                            for (let charIndex = 0; charIndex < normalizedResults.length; charIndex++) {
                                combinedRow.push(...normalizedResults[charIndex][lineIndex]);
                                
                                // Â¶ÇÊûú‰∏çÊòØÊúÄÂêé‰∏Ä‰∏™Â≠óÁ¨¶‰∏îÈúÄË¶ÅÈó¥Ë∑ùÔºåÊ∑ªÂä†Èó¥Ë∑ùÂàó
                                if (charIndex < normalizedResults.length - 1 && spacing > 0) {
                                    for (let s = 0; s < spacing; s++) {
                                        combinedRow.push({
                                            originalMoonPhase: 'üåë',
                                            finalMoonPhase: 'üåë',
                                            densityLevel: 'ÊûÅ‰ΩéÂØÜÂ∫¶',
                                            densitySymbol: '‚¨õ',
                                            bias: 'balanced',
                                            blackCount: 0,
                                            centerX: 2
                                        });
                                    }
                                }
                            }
                            
                            globalMetaGrid.push(combinedRow);
                        }
                    }
                    
                    console.log(`ÂÖ®Â±ÄÁΩëÊ†ºÂàõÂª∫ÂÆåÊàê: ${globalMetaGrid[0]?.length || 0}Âàó x ${globalMetaGrid.length}Ë°å`);
                    
                    // ‰ªéUIËé∑ÂèñÂûÇÁõ¥ÂåñÂ§ÑÁêÜËÆæÁΩÆ
                    const targetDensityLevels = [];
                    if (document.getElementById('verticalMedium').checked) {
                        targetDensityLevels.push('‰∏≠Á≠âÂØÜÂ∫¶');
                    }
                    if (document.getElementById('verticalHigh').checked) {
                        targetDensityLevels.push('Ê¨°È´òÂØÜÂ∫¶');
                    }
                    const thresholdN = 2; // ÈªòËÆ§ÈòàÂÄº
                    
                    globalMetaGrid = this.applyVerticalProcessing(globalMetaGrid, targetDensityLevels, thresholdN);
                    
                    // È™åËØÅÂûÇÁõ¥ÂåñÂ§ÑÁêÜÁöÑÁªìÊûú
                    console.error(`üîç È™åËØÅÂûÇÁõ¥ÂåñÂ§ÑÁêÜÁªìÊûú:`);
                    let avoidCount = 0, keepCount = 0;
                    this.verticalProcessingPositions.forEach(pos => {
                        if (pos.row < globalMetaGrid.length && pos.col < globalMetaGrid[pos.row].length) {
                            const cell = globalMetaGrid[pos.row][pos.col];
                            console.error(`È™åËØÅ‰ΩçÁΩÆ(${pos.row},${pos.col}): finalMoonPhase=${cell.finalMoonPhase}, ÂØÜÂ∫¶=${cell.densityLevel}`);
                            if (cell.finalMoonPhase === 'üåë') {
                                avoidCount++;
                            } else if (cell.finalMoonPhase === 'üåï') {
                                keepCount++;
                            }
                        }
                    });
                    console.error(`üìä ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÁªüËÆ°: ÈÅøËÆ©üåë=${avoidCount}‰∏™, ‰øùÊåÅüåï=${keepCount}‰∏™`);
                    
                    // ‰ªéÂ§ÑÁêÜÂêéÁöÑÂÖÉÊï∞ÊçÆÁΩëÊ†ºÊèêÂèñÊúÄÁªàÊúàÁõ∏
                    const resultLines = globalMetaGrid.map(row => 
                        row.map(cell => cell.finalMoonPhase).join('')
                    );
                    
                    let result = resultLines.join('\n');
                    
                    // Â¶ÇÊûúÂêØÁî®Ë∞ÉËØïÊ®°ÂºèÔºåÂ∫îÁî®ÂûÇÁõ¥ÂåñË∞ÉËØïÁ¨¶Âè∑
                    if (showVerticalDebug) {
                        result = this.applyVerticalDebugSymbols(result);
                        console.log(`ÂûÇÁõ¥ÂåñË∞ÉËØïÁ¨¶Âè∑Â∑≤Â∫îÁî®ÔºåÂÖ±${this.verticalProcessingPositions.length}‰∏™‰ΩçÁΩÆ`);
                    }
                    
                    console.log(`ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÂÆåÊàêÔºåÂ≠óÁ¨¶Êï∞: ${chars.length}, ÁªìÊûúË°åÊï∞: ${result.split('\n').length}`);
                    
                    // Â∫îÁî®ËæπË∑ù
                    if (padding > 0) {
                        result = this.applyPadding(result, padding);
                        console.log(`ËæπË∑ùÂ∫îÁî®ÂÆåÊàêÔºåËæπË∑ùÂÆΩÂ∫¶: ${padding}`);
                    }
                    
                    return result;
                    
                } else {
                    // ‰º†ÁªüÂ§ÑÁêÜÊñπÂºèÔºàÊó†ÂûÇÁõ¥ÂåñÔºâ
                    const charResults = chars.map(char => {
                        return this.generateSingleChar(char, sizeParam, fontType, isVertical);
                    });
                    
                    // Ê†πÊçÆÊéíÁâàÊñπÂêëÊãºÊé•ÁªìÊûú
                    let result;
                    if (isVertical) {
                        result = this.combineVertically(charResults, spacing, sizeParam);
                    } else {
                        result = this.combineHorizontally(charResults, spacing, sizeParam);
                    }
                    
                    console.log(`ÂçïÂ≠óÁ¨¶ÁîüÊàêÂÆåÊàêÔºåÂ≠óÁ¨¶Êï∞: ${chars.length}, ÁªìÊûúË°åÊï∞: ${result.split('\n').length}`);
                    
                    // Â∫îÁî®ËæπË∑ù
                    if (padding > 0) {
                        result = this.applyPadding(result, padding);
                        console.log(`ËæπË∑ùÂ∫îÁî®ÂÆåÊàêÔºåËæπË∑ùÂÆΩÂ∫¶: ${padding}`);
                    }
                    
                    return result;
                }
            }
        }
        
        // Â≠ó‰ΩìÊò†Â∞Ñ
        const FONT_FAMILIES = {
            'default': 'sans-serif',
            'gothic': '"„É°„Ç§„É™„Ç™", "Meiryo", "Hiragino Kaku Gothic ProN", "Ê∏∏„Ç¥„Ç∑„ÉÉ„ÇØ", "Yu Gothic", "MS P„Ç¥„Ç∑„ÉÉ„ÇØ", "MS PGothic", sans-serif',
            'mincho': '"Ê∏∏ÊòéÊúù", "Yu Mincho", "Hiragino Mincho ProN", "MS ÊòéÊúù", "MS Mincho", serif'
        };

        // Â≠ó‰ΩìÈ¢ÑËÆæÈÖçÁΩÆÔºöÁ≤òÂêàÁ≥ªÊï∞ÂíåÂûÇÁõ¥ÂåñÂ§ÑÁêÜÂØÜÂ∫¶Á∫ßÂà´
        const FONT_CONFIGS = {
            'default': { 
                adhesionCoefficient: 2,
                verticalDensityLevels: ['‰∏≠Á≠âÂØÜÂ∫¶', 'Ê¨°È´òÂØÜÂ∫¶']
            },
            'gothic': { 
                adhesionCoefficient: 2,
                verticalDensityLevels: ['‰∏≠Á≠âÂØÜÂ∫¶', 'Ê¨°È´òÂØÜÂ∫¶']
            },
            'mincho': { 
                adhesionCoefficient: 3,
                verticalDensityLevels: []  // ÊòéÊúù‰Ωì‰∏ç‰ΩøÁî®ÂûÇÁõ¥ÂåñÂ§ÑÁêÜ
            }
        };
        
        // ÂàùÂßãÂåñ
        const generator = new SimpleMoonGenerator();
        const horizontalEnhancer = new HorizontalEnhancer();
        
        // Êõ¥Êñ∞ÊªëÂùóÊ†áÁ≠æÁöÑÂáΩÊï∞
        function updateSliderLabel() {
            const isVertical = document.querySelector('input[name="textDirection"]:checked').value === 'vertical';
            const sliderLabel = document.getElementById('sliderLabel');
            const sliderUnit = document.getElementById('sliderUnit');
            
            if (isVertical) {
                sliderLabel.textContent = 'ÂπÖÊñáÂ≠óÊï∞';
                sliderUnit.textContent = 'ÊñáÂ≠ó';
            } else {
                sliderLabel.textContent = 'È´ò„Åï';
                sliderUnit.textContent = 'Ë°å';
            }
        }
        
        // Â§çÂà∂ÂäüËÉΩ
        function copyToClipboard() {
            const moonArt = document.getElementById('moonArt').textContent;
            if (!moonArt || moonArt.includes('ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ') || moonArt.includes('„Ç®„É©„Éº')) return;
            
            navigator.clipboard.writeText(moonArt).then(() => {
                const copyBtn = document.getElementById('copyBtn');
                const btnText = copyBtn.querySelector('.btn-text');
                const originalText = btnText.textContent;
                
                btnText.textContent = '„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ';
                copyBtn.classList.add('success');
                
                setTimeout(() => {
                    btnText.textContent = originalText;
                    copyBtn.classList.remove('success');
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }
        
        // ÊñáÊú¨‰∏ãËΩΩÂäüËÉΩ
        function downloadText() {
            const moonArt = document.getElementById('moonArt').textContent;
            if (!moonArt || moonArt.includes('ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ') || moonArt.includes('„Ç®„É©„Éº')) return;
            
            const randomId = Math.random().toString(36).substring(2, 8);
            const filename = `moon-art-${randomId}-${Date.now()}.txt`;
            
            const blob = new Blob([moonArt], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        // ÂõæÁâá‰∏ãËΩΩÂäüËÉΩ
        function downloadImage() {
            const moonArt = document.getElementById('moonArt').textContent;
            if (!moonArt || moonArt.includes('ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ') || moonArt.includes('„Ç®„É©„Éº')) return;
            
            // ÂàõÂª∫ÁîªÂ∏É
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const lines = moonArt.split('\n');
            const fontSize = 20;
            const lineHeight = fontSize;
            
            // ËÆ°ÁÆóÁîªÂ∏ÉÂ∞∫ÂØ∏
            canvas.width = lines[0].length * fontSize / 2;
            canvas.height = lines.length * lineHeight;
            
            // ÁªòÂà∂Êúà‰∫ÆËâ∫ÊúØÔºàÈÄèÊòéËÉåÊôØÔºâ
            ctx.fillStyle = 'black';
            ctx.font = `${fontSize}px sans-serif`;
            ctx.textBaseline = 'top';
            
            lines.forEach((line, lineIndex) => {
                let x = 0;
                for (let i = 0; i < line.length; i += 2) {
                    const emoji = line.substr(i, 2);
                    ctx.fillText(emoji, x, lineIndex * lineHeight);
                    x += fontSize;
                }
            });
            
            // ‰∏ãËΩΩÂõæÁâá
            const randomId = Math.random().toString(36).substring(2, 8);
            const filename = `moon-art-${randomId}-${Date.now()}.png`;
            
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);
            }, 'image/png');
        }
        
        // Áªü‰∏ÄÁöÑÈ¢ÑËßàÊõ¥Êñ∞ÂáΩÊï∞ÔºàÊ†πÊçÆÂΩìÂâçÊ®°ÂºèË∞ÉÁî®Áõ∏Â∫îÁöÑÂ§ÑÁêÜÂáΩÊï∞Ôºâ
        function updatePreview() {
            console.log(`updatePreview - ÂΩìÂâçÊ®°Âºè: ${currentInputMode}`);
            
            // Ê†πÊçÆÂΩìÂâçÊ®°ÂºèÂÜ≥ÂÆöÂ§ÑÁêÜÊñπÂºè
            if (currentInputMode === 'image' && lastUploadedImageSrc) {
                // ÂõæÁâáÊ®°ÂºèÔºöÈáçÊñ∞ÁîüÊàêÂõæÁâáÁöÑÊúàÊñáÂ≠ó
                console.log('Êõ¥Êñ∞ÂõæÁâáÈ¢ÑËßà');
                generateFromImage(lastUploadedImageSrc);
            } else if (currentInputMode === 'text') {
                // ÊñáÂ≠óÊ®°ÂºèÔºöÊâßË°åÂéüÊúâÁöÑÊñáÂ≠óÂ§ÑÁêÜÈÄªËæë
                console.log('Êõ¥Êñ∞ÊñáÂ≠óÈ¢ÑËßà');
                updateTextPreview();
            } else {
                // Ê≤°ÊúâÂÜÖÂÆπÊó∂ÊòæÁ§∫ÊèêÁ§∫
                document.getElementById('moonArt').textContent = '<!-- ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ -->';
                document.getElementById('actionButtons').style.display = 'none';
                document.getElementById('debugInfo').style.display = 'none';
            }
        }
        
        // ÊñáÂ≠óÊ®°ÂºèÁöÑÈ¢ÑËßàÊõ¥Êñ∞
        function updateTextPreview() {
            const text = document.getElementById('textInput').value.trim();
            const sizeValue = parseInt(document.getElementById('heightSlider').value);
            const fontType = document.getElementById('fontSelect').value;
            const adhesionCoefficient = parseInt(document.getElementById('adhesionSlider').value);
            const spacing = parseInt(document.getElementById('spacingSlider').value);
            const padding = parseInt(document.getElementById('paddingSlider').value);
            
            const selectedRadio = document.querySelector('input[name="textDirection"]:checked');
            console.log('updatePreview - ÈÄâ‰∏≠ÁöÑradioÊåâÈíÆ:', selectedRadio);
            console.log('updatePreview - ÈÄâ‰∏≠ÁöÑÂÄº:', selectedRadio?.value);
            const isVertical = selectedRadio?.value === 'vertical';
            console.log('updatePreview - ÊúÄÁªàisVerticalÂÄº:', isVertical);
            
            const reverseColor = document.getElementById('reverseColor').checked;
            const showVerticalInfo = document.getElementById('showVerticalInfo').checked;
            const enableDenoising = document.getElementById('enableDenoising').checked;
            
            if (!text) {
                document.getElementById('moonArt').textContent = '<!-- ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ -->';
                document.getElementById('actionButtons').style.display = 'none';
                document.getElementById('debugInfo').style.display = 'none';
                return;
            }
            
            try {
                // ÁîüÊàêÂü∫Á°ÄÁªìÊûúÔºàÂêØÁî®ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÔºå‰∏çÊâßË°åÂèçËâ≤Ôºâ
                let result = generator.generate(text, sizeValue, fontType, isVertical, false, spacing, true, false, padding); // ÂÖà‰∏çÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØ
                
                // Ê∑ªÂä†ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÂêéÁöÑË∞ÉËØïËæìÂá∫
                console.log(`üîÑ ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÂÆåÊàêÔºåÂáÜÂ§áËøõË°åÊ®™ÂêëÂä†Âº∫ÁÆóÊ≥ï`);
                console.log(`ÂûÇÁõ¥ÂåñÂ§ÑÁêÜËÆ∞ÂΩïÊï∞: ${generator.verticalProcessingPositions.length}`);
                if (generator.verticalProcessingPositions.length > 0) {
                    console.log(`ÂûÇÁõ¥ÂåñÂ§ÑÁêÜËØ¶ÊÉÖ:`, generator.verticalProcessingPositions);
                    const lines = result.split('\n');
                    generator.verticalProcessingPositions.forEach(pos => {
                        if (pos.row < lines.length && pos.col < lines[pos.row].length) {
                            const char = Array.from(lines[pos.row])[pos.col];
                            console.log(`‰ΩçÁΩÆ(${pos.row},${pos.col}): ÂΩìÂâçÂ≠óÁ¨¶=${char}, ÂØÜÂ∫¶=${pos.densityLevel}`);
                        }
                    });
                }
                
                // Â∫îÁî®Ê®™ÂêëÂä†Âº∫ÁÆóÊ≥ï
                horizontalEnhancer.setAdhesionCoefficient(adhesionCoefficient);
                horizontalEnhancer.setEnableDenoising(enableDenoising);
                result = horizontalEnhancer.enhance(result);
                
                // Â¶ÇÊûúÂêØÁî®ÂûÇÁõ¥ÂåñË∞ÉËØï‰ø°ÊÅØÔºåÂú®Ê®™ÂêëÂä†Âº∫ÁÆóÊ≥ï‰πãÂêéÊòæÁ§∫
                if (showVerticalInfo) {
                    result = generator.applyVerticalDebugSymbols(result);
                    console.log(`ÂûÇÁõ¥ÂåñË∞ÉËØïÁ¨¶Âè∑Â∑≤Â∫îÁî®ÔºàÊ®™ÂêëÂä†Âº∫ÂêéÔºâÔºåÂÖ±${generator.verticalProcessingPositions.length}‰∏™‰ΩçÁΩÆ`);
                }
                
                // ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÁöÑÊúÄÁªàÁªìÊûúÊ£ÄÊü•
                console.log(`üîç ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÊúÄÁªàÁªìÊûúÊ£ÄÊü•ÔºàÊó†Ê®™ÂêëÂπ≤Êâ∞Ôºâ`);
                if (generator.verticalProcessingPositions.length > 0) {
                    const linesFinal = result.split('\n');
                    let moon_count = 0, black_count = 0;
                    
                    generator.verticalProcessingPositions.forEach(pos => {
                        if (pos.row < linesFinal.length && pos.col < linesFinal[pos.row].length) {
                            const charFinal = Array.from(linesFinal[pos.row])[pos.col];
                            console.log(`ÊúÄÁªà‰ΩçÁΩÆ(${pos.row},${pos.col}): Â≠óÁ¨¶=${charFinal}, ÂØÜÂ∫¶=${pos.densityLevel}`);
                            
                            if (charFinal === 'üåï') moon_count++;
                            else if (charFinal === 'üåë') black_count++;
                        }
                    });
                    
                    console.error(`üìä ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÁªüËÆ°: üåï=${moon_count}‰∏™, üåë=${black_count}‰∏™`);
                    
                    // Ê£ÄÊü•Êï¥‰∏™ÁªìÊûúÂ≠óÁ¨¶‰∏≤ÁöÑÂÜÖÂÆπÁªüËÆ°
                    const allChars = result.replace(/\n/g, '');
                    const totalMoon = (allChars.match(/üåï/g) || []).length;
                    const totalBlack = (allChars.match(/üåë/g) || []).length;
                    console.error(`üìä Êï¥‰ΩìÂ≠óÁ¨¶ÁªüËÆ°: ÊÄªüåï=${totalMoon}‰∏™, ÊÄªüåë=${totalBlack}‰∏™`);
                }
                
                // ÊúÄÂêéÊâßË°åÂèçËâ≤Êìç‰Ωú
                if (reverseColor) {
                    result = Array.from(result).map(char => {
                        if (char === '\n') return char;
                        return generator.reverseMoon(char);
                    }).join('');
                }
                
                document.getElementById('moonArt').textContent = result;
                
                // ÊòæÁ§∫ÂûÇÁõ¥ÂåñÂ§ÑÁêÜË∞ÉËØï‰ø°ÊÅØ
                document.getElementById('debugInfo').style.display = 'block';
                const fontConfig = FONT_CONFIGS[fontType] || FONT_CONFIGS['default'];
                const verticalDensityLevels = fontConfig.verticalDensityLevels || [];
                const isVerticalEnabled = verticalDensityLevels.length > 0;
                document.getElementById('verticalProcessingStatus').textContent = isVerticalEnabled ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ';
                document.getElementById('targetDensityLevels').textContent = verticalDensityLevels.length > 0 ? verticalDensityLevels.join('„ÄÅ') : '„Å™„Åó';
                document.getElementById('thresholdN').textContent = '2';
                document.getElementById('processingMode').textContent = `${fontType}È†êË®≠: ${verticalDensityLevels.length > 0 ? verticalDensityLevels.join('„Éª') : '„Å™„Åó'}`;
                
                // ÊòæÁ§∫Êìç‰ΩúÊåâÈíÆ
                document.getElementById('actionButtons').style.display = 'flex';
                
                    
            } catch (error) {
                console.error('Generation error:', error);
                document.getElementById('moonArt').textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                document.getElementById('actionButtons').style.display = 'none';
                document.getElementById('debugInfo').style.display = 'none';
            }
        }
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        // Ê£ÄÊµãÊòØÂê¶‰∏∫ÁßªÂä®ËÆæÂ§á
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (navigator.maxTouchPoints && navigator.maxTouchPoints > 1) ||
                   window.innerWidth <= 768;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const heightSlider = document.getElementById('heightSlider');
            const heightValue = document.getElementById('heightValue');
            const adhesionSlider = document.getElementById('adhesionSlider');
            const adhesionValue = document.getElementById('adhesionValue');
            const spacingSlider = document.getElementById('spacingSlider');
            const spacingValue = document.getElementById('spacingValue');
            
            heightSlider.addEventListener('input', () => {
                heightValue.textContent = heightSlider.value;
                
                // Êõ¥Êñ∞ÂØπÂ∫îÊ®°ÂºèÁöÑËÆæÁΩÆ
                if (currentInputMode === 'text') {
                    textModeSettings.height = parseInt(heightSlider.value);
                } else {
                    imageModeSettings.height = parseInt(heightSlider.value);
                }
                
                updatePreview();
            });
            
            adhesionSlider.addEventListener('input', () => {
                adhesionValue.textContent = adhesionSlider.value;
                updatePreview();
            });
            
            spacingSlider.addEventListener('input', () => {
                spacingValue.textContent = spacingSlider.value;
                updatePreview();
            });
            
            const paddingSlider = document.getElementById('paddingSlider');
            const paddingValue = document.getElementById('paddingValue');
            
            paddingSlider.addEventListener('input', () => {
                paddingValue.textContent = paddingSlider.value;
                
                // Êõ¥Êñ∞ÂØπÂ∫îÊ®°ÂºèÁöÑËÆæÁΩÆ
                if (currentInputMode === 'text') {
                    textModeSettings.padding = parseInt(paddingSlider.value);
                } else {
                    imageModeSettings.padding = parseInt(paddingSlider.value);
                }
                
                updatePreview();
            });
            
            document.getElementById('textInput').addEventListener('input', updatePreview);
            document.getElementById('fontSelect').addEventListener('change', (e) => {
                // ÂàáÊç¢Â≠ó‰ΩìÊó∂Ëá™Âä®Â∫îÁî®È¢ÑËÆæÈÖçÁΩÆ
                const fontType = e.target.value;
                const config = FONT_CONFIGS[fontType] || FONT_CONFIGS['default'];
                
                // Êõ¥Êñ∞Á≤òÂêàÁ≥ªÊï∞
                adhesionSlider.value = config.adhesionCoefficient;
                adhesionValue.textContent = config.adhesionCoefficient;
                
                // Êõ¥Êñ∞ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
                document.getElementById('verticalMedium').checked = 
                    config.verticalDensityLevels.includes('‰∏≠Á≠âÂØÜÂ∫¶');
                document.getElementById('verticalHigh').checked = 
                    config.verticalDensityLevels.includes('Ê¨°È´òÂØÜÂ∫¶');
                
                // ÊòæÁ§∫ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÈÖçÁΩÆ‰ø°ÊÅØÔºàÂú®Ë∞ÉËØï‰ø°ÊÅØ‰∏≠ÊòæÁ§∫Ôºâ
                console.log(`Â≠ó‰ΩìÂàáÊç¢Âà∞: ${fontType}, ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÂØÜÂ∫¶Á∫ßÂà´: ${config.verticalDensityLevels.join(', ') || 'Êó†'}`);
                
                updatePreview();
            });
            document.getElementById('showDebugCanvas').addEventListener('change', updatePreview);
            
            // Ê∑ªÂä†ÊñπÂêëÈÄâÊã©‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.querySelectorAll('input[name="textDirection"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    updateSliderLabel(); // Êõ¥Êñ∞Ê†áÁ≠æ
                    updatePreview(); // ÈáçÊñ∞ÁîüÊàê
                });
            });
            
            // Ê∑ªÂä†ÂèçËâ≤Â§çÈÄâÊ°Ü‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('reverseColor').addEventListener('change', updatePreview);
            
            // Ê∑ªÂä†ÂûÇÁõ¥Âåñ‰ø°ÊÅØÂ§çÈÄâÊ°Ü‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('showVerticalInfo').addEventListener('change', updatePreview);
            
            // Ê∑ªÂä†ÂûÇÁõ¥ÂåñÂ§ÑÁêÜÊéßÂà∂Â§çÈÄâÊ°Ü‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('verticalMedium').addEventListener('change', updatePreview);
            document.getElementById('verticalHigh').addEventListener('change', updatePreview);
            
            // Ê∑ªÂä†ÂéªÂô™Â§ÑÁêÜÊéßÂà∂Â§çÈÄâÊ°Ü‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('enableDenoising').addEventListener('change', updatePreview);
            
            
            // Ê∑ªÂä†ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
            document.getElementById('downloadTextBtn').addEventListener('click', downloadText);
            document.getElementById('downloadImageBtn').addEventListener('click', downloadImage);
            
            // ‰ªÖÂú®Ê°åÈù¢ËÆæÂ§á‰∏äÊ∑ªÂä†Êî∂ËóèÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
            if (!isMobileDevice()) {
                document.getElementById('bookmarkBtn').addEventListener('click', addBookmark);
            } else {
                // ÁßªÂä®ËÆæÂ§á‰∏äÂÆåÂÖ®ÈöêËóèÊåâÈíÆ
                const bookmarkBtn = document.getElementById('bookmarkBtn');
                if (bookmarkBtn) {
                    bookmarkBtn.style.display = 'none';
                }
            }
            
            // Ê†πÊçÆËÆæÂ§áÁ±ªÂûãËÆæÁΩÆÈªòËÆ§ÊñπÂêëÔºà‰ªÖÂú®Ê≤°ÊúâÈÄâÊã©Êó∂Ôºâ
            const currentSelection = document.querySelector('input[name="textDirection"]:checked');
            if (!currentSelection) {
                if (isMobileDevice()) {
                    document.querySelector('input[name="textDirection"][value="vertical"]').checked = true;
                } else {
                    document.querySelector('input[name="textDirection"][value="horizontal"]').checked = true;
                }
                // ËÆæÁΩÆÈªòËÆ§ÂÄºÂêéÔºåÊõ¥Êñ∞Ê†áÁ≠æÂíåÈ¢ÑËßà
                updateSliderLabel();
            }
            
            // ÂàùÂßãÂåñÂ≠ó‰ΩìÈ¢ÑËÆæÈÖçÁΩÆ
            const defaultFontType = document.getElementById('fontSelect').value;
            const defaultConfig = FONT_CONFIGS[defaultFontType] || FONT_CONFIGS['default'];
            adhesionSlider.value = defaultConfig.adhesionCoefficient;
            adhesionValue.textContent = defaultConfig.adhesionCoefficient;
            
            // ÂàùÂßãÂåñÊ†áÁ≠æÂíåÁîüÊàêÔºàÂª∂ËøüÊâßË°åÁ°Æ‰øùDOMÁä∂ÊÄÅÊõ¥Êñ∞Ôºâ
            setTimeout(() => {
                updateSliderLabel();
                updatePreview();
            }, 0);
            
            // ËÆæÁΩÆÈ°µËÑöÊî∂ËóèÊåâÈíÆ
            setupFooterBookmark();
            
            // ÂàùÂßãÂåñTabÂäüËÉΩ
            initializeTabs();
            
            // ÂàùÂßãÂåñÂõæÁâá‰∏ä‰º†ÂäüËÉΩ
            initializeImageUpload();
        });
        
        // Ë∞ÉËØïÂèÇÊï∞ÂàáÊç¢ÂäüËÉΩ
        function toggleDebugSection() {
            const debugControls = document.getElementById('debugControls');
            const debugToggleIcon = document.getElementById('debugToggleIcon');
            
            if (debugControls.classList.contains('expanded')) {
                // Êî∂Ëµ∑
                debugControls.classList.remove('expanded');
                debugToggleIcon.textContent = '‚ñ∂';
                debugToggleIcon.style.transform = 'rotate(0deg)';
            } else {
                // Â±ïÂºÄ
                debugControls.classList.add('expanded');
                debugToggleIcon.textContent = '‚ñº';
                debugToggleIcon.style.transform = 'rotate(90deg)';
            }
        }
        
        // TabÂàáÊç¢ÂäüËÉΩ
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // ÁßªÈô§ÊâÄÊúâactiveÁ±ª
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Ê∑ªÂä†activeÁ±ªÂà∞ÂΩìÂâçÈÄâ‰∏≠ÁöÑtab
                    button.classList.add('active');
                    if (tabId === 'text') {
                        document.getElementById('textTab').classList.add('active');
                        
                        // ‰øùÂ≠òÂõæÁâáÊ®°ÂºèÁöÑËÆæÁΩÆÔºàÂ¶ÇÊûúÂΩìÂâçÊòØÂõæÁâáÊ®°ÂºèÔºâ
                        if (currentInputMode === 'image') {
                            imageModeSettings.height = parseInt(document.getElementById('heightSlider').value);
                            imageModeSettings.padding = parseInt(document.getElementById('paddingSlider').value);
                        }
                        
                        currentInputMode = 'text'; // Êõ¥Êñ∞ÂΩìÂâçÊ®°Âºè
                        
                        // ÊñáÂ≠óÊ®°ÂºèÔºöË∞ÉÊï¥È´ò„ÅïÊªëÂùóËåÉÂõ¥‰∏∫10-60
                        const heightSlider = document.getElementById('heightSlider');
                        const heightMaxLabel = heightSlider.nextElementSibling;
                        heightSlider.max = 60;
                        heightMaxLabel.textContent = '60';
                        
                        // ÊÅ¢Â§çÊñáÂ≠óÊ®°ÂºèÁöÑËÆæÁΩÆ
                        heightSlider.value = textModeSettings.height;
                        document.getElementById('heightValue').textContent = textModeSettings.height;
                        document.getElementById('paddingSlider').value = textModeSettings.padding;
                        document.getElementById('paddingValue').textContent = textModeSettings.padding;
                        
                        // Â¶ÇÊûúÊñáÂ≠óËæìÂÖ•Ê°ÜÊúâÂÜÖÂÆπÔºåÈáçÊñ∞ÁîüÊàêÈ¢ÑËßà
                        const textInput = document.getElementById('textInput').value.trim();
                        if (textInput) {
                            setTimeout(() => updatePreview(), 0);
                        } else {
                            // Ê≤°ÊúâÊñáÂ≠óÊó∂Ê∏ÖÁ©∫È¢ÑËßà
                            document.getElementById('moonArt').textContent = '<!-- ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ -->';
                            document.getElementById('debugInfo').style.display = 'none';
                            document.getElementById('actionButtons').style.display = 'none';
                        }
                    } else if (tabId === 'image') {
                        document.getElementById('imageTab').classList.add('active');
                        
                        // ‰øùÂ≠òÊñáÂ≠óÊ®°ÂºèÁöÑËÆæÁΩÆÔºàÂ¶ÇÊûúÂΩìÂâçÊòØÊñáÂ≠óÊ®°ÂºèÔºâ
                        if (currentInputMode === 'text') {
                            textModeSettings.height = parseInt(document.getElementById('heightSlider').value);
                            textModeSettings.padding = parseInt(document.getElementById('paddingSlider').value);
                        }
                        
                        currentInputMode = 'image'; // Êõ¥Êñ∞ÂΩìÂâçÊ®°Âºè
                        
                        // ÂõæÁâáÊ®°ÂºèÔºöË∞ÉÊï¥È´ò„ÅïÊªëÂùóËåÉÂõ¥‰∏∫10-500
                        const heightSlider = document.getElementById('heightSlider');
                        const heightMaxLabel = heightSlider.nextElementSibling;
                        heightSlider.max = 500;
                        heightMaxLabel.textContent = '500';
                        
                        // ÊÅ¢Â§çÂõæÁâáÊ®°ÂºèÁöÑËÆæÁΩÆ
                        heightSlider.value = imageModeSettings.height;
                        document.getElementById('heightValue').textContent = imageModeSettings.height;
                        document.getElementById('paddingSlider').value = imageModeSettings.padding;
                        document.getElementById('paddingValue').textContent = imageModeSettings.padding;
                        
                        // Â¶ÇÊûúÊúâ‰∏ä‰º†ÁöÑÂõæÁâáÔºåÈáçÊñ∞ÁîüÊàêÈ¢ÑËßà
                        if (lastUploadedImageSrc) {
                            setTimeout(() => updatePreview(), 0);
                        } else {
                            // Ê≤°ÊúâÂõæÁâáÊó∂Ê∏ÖÁ©∫È¢ÑËßà
                            document.getElementById('moonArt').textContent = '<!-- ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ -->';
                            document.getElementById('debugInfo').style.display = 'none';
                            document.getElementById('actionButtons').style.display = 'none';
                        }
                    }
                });
            });
        }
        
        // ÂõæÁâá‰∏ä‰º†ÂäüËÉΩ
        function initializeImageUpload() {
            const imageInput = document.getElementById('imageInput');
            const uploadButton = document.getElementById('uploadButton');
            const uploadArea = document.getElementById('imageUploadArea');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const imageInfo = document.getElementById('imageInfo');
            const removeButton = document.getElementById('removeImage');
            
            // ÁÇπÂáª‰∏ä‰º†ÊåâÈíÆ
            uploadButton.addEventListener('click', () => {
                imageInput.click();
            });
            
            // ÁÇπÂáª‰∏ä‰º†Âå∫Âüü
            uploadArea.addEventListener('click', (e) => {
                if (e.target === uploadArea || e.target.classList.contains('upload-icon') || 
                    e.target.classList.contains('upload-text') || e.target.classList.contains('upload-hint')) {
                    imageInput.click();
                }
            });
            
            // Êñá‰ª∂ÈÄâÊã©
            imageInput.addEventListener('change', handleFileSelect);
            
            // ÊãñÊãΩ‰∏ä‰º†
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    handleFile(files[0]);
                }
            });
            
            // Âà†Èô§ÂõæÁâá
            removeButton.addEventListener('click', () => {
                imageInput.value = '';
                uploadArea.style.display = 'flex';
                imagePreview.style.display = 'none';
                
                // Ê∏ÖÁ©∫‰øùÂ≠òÁöÑÂõæÁâáÊ∫ê
                lastUploadedImageSrc = null;
                console.log('ÂõæÁâáÂ∑≤Âà†Èô§ÔºåÊ∏ÖÁ©∫ÂõæÁâáÊ∫ê');
                
                // Ê∏ÖÁ©∫È¢ÑËßà
                document.getElementById('moonArt').textContent = '<!-- ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ -->';
                document.getElementById('debugInfo').style.display = 'none';
                document.getElementById('actionButtons').style.display = 'none';
            });
            
            // Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
            function handleFileSelect(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    handleFile(file);
                }
            }
            
            // Â§ÑÁêÜÊñá‰ª∂
            function handleFile(file) {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    imageInfo.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                    
                    uploadArea.style.display = 'none';
                    imagePreview.style.display = 'block';
                    
                    // ‰øùÂ≠òÂõæÁâáÊ∫êÂπ∂ËÆæÁΩÆÂΩìÂâçÊ®°Âºè
                    lastUploadedImageSrc = e.target.result;
                    currentInputMode = 'image';
                    console.log('ÂõæÁâáÂ∑≤‰∏ä‰º†ÔºåÂàáÊç¢Âà∞ÂõæÁâáÊ®°Âºè');
                    
                    // Ëá™Âä®ÁîüÊàêÈ¢ÑËßà
                    setTimeout(() => {
                        generateFromImage(e.target.result);
                    }, 100);
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        // ‰ªéÂõæÁâáÁîüÊàêÊúàÊñáÂ≠óÔºàÂÆåÊï¥ÂÆûÁé∞Ôºâ
        async function generateFromImage(imageSrc) {
            try {
                // ÊòæÁ§∫Â§ÑÁêÜ‰∏≠Áä∂ÊÄÅ
                document.getElementById('moonArt').textContent = 'Âá¶ÁêÜ‰∏≠...';
                
                // Ëé∑ÂèñÁî®Êà∑ËÆæÁΩÆ
                const height = parseInt(document.getElementById('heightSlider').value);
                const padding = parseInt(document.getElementById('paddingSlider').value);
                const reverseColor = document.getElementById('reverseColor').checked;
                const showVerticalInfo = document.getElementById('showVerticalInfo').checked;
                const enableDenoising = document.getElementById('enableDenoising').checked;
                const adhesionCoefficient = parseInt(document.getElementById('adhesionSlider').value);
                // ÂàõÂª∫ÂõæÁâáÂ§ÑÁêÜÂô®
                const imageProcessor = new ImageProcessor();
                
                // Â§ÑÁêÜÂõæÁâáÔºàÂõ∫ÂÆöÂêØÁî®ÁÅ∞Â∫¶Â§ÑÁêÜÔºâ
                const imageData = await imageProcessor.loadAndProcessImage(imageSrc, height, true);
                
                console.log(`ÂõæÁâáÊï∞ÊçÆÂáÜÂ§áÂÆåÊàê: ${imageData.width}x${imageData.height}`);
                
                // ‰ΩøÁî®SimpleMoonGeneratorÁöÑ‰∏ìÈó®ÂõæÁâáÂ§ÑÁêÜÊµÅÁ®ã
                const generator = new SimpleMoonGenerator();
                
                // ‰ΩøÁî®‰∏ìÈó®ÁöÑÂõæÁâáÂ§ÑÁêÜÊñπÊ≥ïÔºàË∑≥ËøáÊñáÂ≠ó‰ºòÂåñÁÆóÊ≥ïÔºâ
                let result = generator.generateFromImage(
                    imageData.matrix,
                    imageData.width,
                    imageData.height,
                    padding // Áõ¥Êé•‰º†ÂÖ•paddingÂèÇÊï∞
                );
                
                console.log(`ÂõæÁâáÊúàÊñáÂ≠óÁîüÊàêÂÆåÊàêÔºåË°åÊï∞: ${result.split('\n').length}`);
                
                // Â∫îÁî®ÂèçËâ≤ÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
                if (reverseColor) {
                    result = result.split('\n').map(line => {
                        return Array.from(line).map(char => {
                            // ‰ΩøÁî®Áé∞ÊúâÁöÑreverseMoonÊñπÊ≥ï
                            return generator.reverseMoon(char);
                        }).join('');
                    }).join('\n');
                    console.log(`ÂèçËâ≤Â§ÑÁêÜÂÆåÊàê`);
                }
                
                // ÊòæÁ§∫ÁªìÊûú
                document.getElementById('moonArt').textContent = result;
                document.getElementById('actionButtons').style.display = 'flex';
                
                // ÂõæÁâáÊ®°Âºè‰∏çÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØÔºàÂõ†‰∏∫Ê≤°ÊúâÂûÇÁõ¥ÂåñÂ§ÑÁêÜÁ≠âÊñáÂ≠ó‰ºòÂåñÔºâ
                document.getElementById('debugInfo').style.display = 'none';
                
                console.log(`ÂõæÁâáËΩ¨Êç¢ÂÆåÊàêÔºÅÊúÄÁªàÁªìÊûúË°åÊï∞: ${result.split('\n').length}`);
                
            } catch (error) {
                console.error('ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•:', error);
                document.getElementById('moonArt').textContent = '„Ç®„É©„Éº: ÁîªÂÉè„ÅÆÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                document.getElementById('actionButtons').style.display = 'none';
            }
        }
        
        // Êî∂ËóèÂäüËÉΩ
        function addBookmark() {
            const title = 'ÊúàÊñáÂ≠ó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº - MojiMoon';
            const url = 'https://mojimoon.com';
            
            try {
                // Áé∞‰ª£ÊµèËßàÂô®ÁöÑÂ§ÑÁêÜ
                if (navigator.userAgent.indexOf('Chrome') > -1 || navigator.userAgent.indexOf('Safari') > -1) {
                    // Chrome/Safari: ÊòæÁ§∫ÂèãÂ•ΩÁöÑÊèêÁ§∫
                    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                    const shortcut = isMac ? 'Cmd+D' : 'Ctrl+D';
                    alert(`${shortcut} „ÇíÊäº„Åó„Å¶„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑüåô`);
                } else if (window.sidebar && window.sidebar.addPanel) {
                    // Firefox
                    window.sidebar.addPanel(title, url, '');
                } else if (window.external && window.external.AddFavorite) {
                    // Internet Explorer
                    window.external.AddFavorite(url, title);
                } else {
                    // ÂÖ∂‰ªñÊµèËßàÂô®
                    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                    const shortcut = isMac ? 'Cmd+D' : 'Ctrl+D';
                    alert(`${shortcut} „ÇíÊäº„Åó„Å¶„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ`);
                }
            } catch (error) {
                console.error('Bookmark error:', error);
                alert('„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†„Åô„Çã„Å´„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÅÆ„É°„Éã„É•„Éº„Åã„ÇâÊìç‰Ωú„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }
        
        // „Éï„ÉÉ„Çø„ÉºÂèéËóèÊåâÈíÆ‰∫ã‰ª∂
        function setupFooterBookmark() {
            const footerBookmarkBtn = document.getElementById('footerBookmarkBtn');
            if (footerBookmarkBtn && !isMobileDevice()) {
                footerBookmarkBtn.addEventListener('click', addBookmark);
            } else if (footerBookmarkBtn) {
                // ÁßªÂä®ËÆæÂ§á‰∏äÈöêËóèfootter‰∏≠ÁöÑÊî∂ËóèÊåâÈíÆ
                footerBookmarkBtn.style.display = 'none';
            }
        }
    </script>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <h2 style="text-align: center; margin-bottom: 15px; font-size: 1.2rem; font-weight: 600; color: #374151;">„Åì„ÅÆ„Çµ„Ç§„Éà„ÅåÊ∞ó„Å´ÂÖ•„Å£„Åü„Çâ„ÄÅ„Åú„Å≤<button id="footerBookmarkBtn" class="footer-bookmark-btn" title="„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†">„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ</button>„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
        </div>
    </footer>
</body>
</html>