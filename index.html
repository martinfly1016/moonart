<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊúàÊñáÂ≠ó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº | Êúà„ÅÆÁµµÊñáÂ≠ó„Ç¢„Éº„Éà‰ΩúÊàê | ÁÑ°Êñô„ÉÜ„Ç≠„Çπ„ÉàÂ§âÊèõ„ÉÑ„Éº„É´ - MojiMoon</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Êó•Êú¨Ë™û„ÉÜ„Ç≠„Çπ„Éà„ÇíÁæé„Åó„ÅÑÊúà„ÅÆÁµµÊñáÂ≠ó„Ç¢„Éº„Éà„Å´Â§âÊèõ„Åô„ÇãÁÑ°Êñô„Ç™„É≥„É©„Ç§„É≥„ÉÑ„Éº„É´„ÄÇÁ∏¶Êõ∏„Åç„ÉªÊ®™Êõ∏„ÅçÂØæÂøú„ÄÅË§áÊï∞„Éï„Ç©„É≥„ÉàÈÅ∏ÊäûÂèØËÉΩ„ÄÇÊúà„ÅÆÊ∫ÄÊ¨†„ÇíË°®Áèæ„Åó„Åü„É¶„Éã„Éº„ÇØ„Å™„Ç¢„Çπ„Ç≠„Éº„Ç¢„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åø„Åæ„Åõ„Çì„ÅãÔºü">
    <meta name="keywords" content="ÊúàÊñáÂ≠ó,ÁµµÊñáÂ≠ó„Ç¢„Éº„Éà,„ÉÜ„Ç≠„Çπ„Éà„Ç¢„Éº„Éà,„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº,ÁÑ°Êñô„ÉÑ„Éº„É´">
    <meta name="author" content="ÊúàÊñáÂ≠ó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº">
    <meta name="robots" content="index,follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="ÊúàÊñáÂ≠ó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº">
    <meta property="og:description" content="„ÉÜ„Ç≠„Çπ„Éà„ÇíÊúà„ÅÆÁµµÊñáÂ≠ó„Ç¢„Éº„Éà„Å´Â§âÊèõ„Åô„ÇãÁÑ°Êñô„ÉÑ„Éº„É´">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mojimoon.com/">
    <meta property="og:image" content="https://mojimoon.com/moon_icon.png">
    <meta property="og:locale" content="ja_JP">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@mojimoon">
    <meta name="twitter:title" content="ÊúàÊñáÂ≠ó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº">
    <meta name="twitter:description" content="„ÉÜ„Ç≠„Çπ„Éà„ÇíÊúà„ÅÆÁµµÊñáÂ≠ó„Ç¢„Éº„Éà„Å´Â§âÊèõ">
    <meta name="twitter:image" content="https://mojimoon.com/moon_icon.png">
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåô</text></svg>">
    <link rel="icon" type="image/png" sizes="32x32" href="/moon_icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/moon_icon.png">
    <link rel="apple-touch-icon" href="/moon_icon.png">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://mojimoon.com/">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "ÊúàÊñáÂ≠ó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº",
        "description": "„ÉÜ„Ç≠„Çπ„Éà„ÇíÊúà„ÅÆÁµµÊñáÂ≠ó„Ç¢„Éº„Éà„Å´Â§âÊèõ",
        "applicationCategory": "UtilityApplication",
        "operatingSystem": "All",
        "inLanguage": "ja",
        "isAccessibleForFree": true
    }
    </script>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WD9XP5ERGX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-WD9XP5ERGX');
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .text-input {
            width: 100%;
            height: 48px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }
        
        .text-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .height-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .height-slider {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .height-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #fbbf24;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.4);
            transition: all 0.2s ease;
        }
        
        .height-slider::-webkit-slider-thumb:hover {
            background: #f59e0b;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.6);
        }
        
        .font-select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .font-select option {
            background: #4c1d95;
            color: white;
        }
        
        .generate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
        }
        
        .preview-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            min-height: 300px;
        }
        
        .moon-art {
            font-family: monospace;
            font-size: 10px;
            line-height: 1.2;
            white-space: pre;
            overflow-x: auto;
            color: #fff;
            padding-top: 5px;
        }
        
        .debug-info {
            margin-top: 20px;
            font-size: 12px;
            opacity: 0.7;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            flex: 1;
            min-width: 140px;
        }
        
        .copy-btn {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .copy-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
        }
        
        .download-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
        
        .download-btn:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-1px);
        }
        
        .btn-icon {
            font-size: 16px;
        }
        
        .btn-text {
            font-size: 13px;
        }
        
        .copy-btn.success {
            background: linear-gradient(135deg, #059669, #047857);
        }
        
        .direction-control {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .radio-option input[type="radio"],
        .radio-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #8b5cf6;
        }
        
        .radio-label {
            font-weight: 500;
        }
        
        /* „Éï„ÉÉ„Çø„Éº„Çπ„Çø„Ç§„É´ */
        .footer {
            margin-top: 40px;
            padding: 20px 15px;
        }
        
        .footer-bookmark-btn {
            background: none;
            border: none;
            color: #fbbf24;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            padding: 0;
            margin: 0 2px;
            transition: color 0.2s ease;
        }
        
        .footer-bookmark-btn:hover {
            color: #f59e0b;
        }
        
        /* ÊÇ¨ÊµÆÊî∂ËóèÊåâÈíÆ */
        .floating-bookmark {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            gap: 6px;
        }
        
        .floating-bookmark:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(251, 191, 36, 0.5);
        }
        
        /* ÁßªÂä®Á´Ø‰ºòÂåñ */
        @media (max-width: 768px) {
            .header {
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 5px;
            }
            
            .control-panel {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-group h3 {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }
            
            .floating-bookmark {
                display: none;
            }
            
            body {
                padding-top: 10px;
            }
            
            .footer h2 {
                font-size: 1.1rem;
            }
            
            /* ÁßªÂä®Á´ØÊåâÈíÆ‰ºòÂåñ - ÂçïË°åÂ∏ÉÂ±Ä */
            .action-buttons {
                gap: 5px;
                flex-wrap: nowrap;
            }
            
            .action-btn {
                min-width: 0;
                padding: 8px 6px;
                font-size: 12px;
                flex: 1;
            }
            
            .btn-icon {
                font-size: 14px;
            }
            
            .btn-text {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <!-- Floating Bookmark Button -->
    <button id="bookmarkBtn" class="floating-bookmark" title="„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†">
        ‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„Çä
    </button>
    
    <div class="container">
        <header class="header">
            <h1>üåô ÊúàÊñáÂ≠ó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº</h1>
        </header>
        
        <div class="control-panel">
            <div class="form-group">
                <h3 style="margin-bottom: 8px; font-size: 1rem; font-weight: 600;">„ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ</h3>
                <input type="text" id="textInput" class="text-input" placeholder="Â§âÊèõ„Åó„Åü„ÅÑ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" value="ÊúàÊñáÂ≠ó">
            </div>
            
            <div class="form-group">
                <div class="direction-control">
                    <label class="radio-option">
                        <input type="radio" name="textDirection" value="vertical">
                        <span class="radio-label">Á∏¶Êõ∏„Åç</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="textDirection" value="horizontal">
                        <span class="radio-label">Ê®™Êõ∏„Åç</span>
                    </label>
                    <label class="radio-option">
                        <input type="checkbox" id="reverseColor">
                        <span class="radio-label">ÂèçËâ≤</span>
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <h3 style="margin-bottom: 8px; font-size: 1rem; font-weight: 600;">„Éï„Ç©„É≥„ÉàÈÅ∏Êäû</h3>
                <select id="fontSelect" class="font-select">
                    <option value="gothic-bold" selected>„Ç¥„Ç∑„ÉÉ„ÇØÂ§™Â≠ó</option>
                    <option value="hiragino-w8">„Éí„É©„ÇÆ„ÉéËßí„Ç¥ W8</option>
                    <option value="gothic">„Ç¥„Ç∑„ÉÉ„ÇØ‰Ωì</option>
                    <option value="pop">POP‰Ωì</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>ÈòàÂÄºË∞ÉÊï¥: <span id="thresholdValue">6</span></label>
                <div class="height-control">
                    <span>1</span>
                    <input type="range" id="thresholdSlider" class="height-slider" min="1" max="16" value="6">
                    <span>16</span>
                </div>
            </div>
            
            <div class="form-group">
                <label><span id="sliderLabel">È´ò„Åï</span>: <span id="heightValue">10</span><span id="sliderUnit">Ë°å</span></label>
                <div class="height-control">
                    <span>10</span>
                    <input type="range" id="heightSlider" class="height-slider" min="10" max="60" value="10">
                    <span>60</span>
                </div>
            </div>
            
            
            
            <!-- Action Buttons -->
            <div id="actionButtons" class="action-buttons" style="display: none;">
                <button id="copyBtn" class="action-btn copy-btn">
                    <span class="btn-icon">üìã</span>
                    <span class="btn-text">„Ç≥„Éî„Éº</span>
                </button>
                <button id="downloadTextBtn" class="action-btn download-btn">
                    <span class="btn-icon">üìÑ</span>
                    <span class="btn-text">„ÉÜ„Ç≠„Çπ„Éà„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</span>
                </button>
                <button id="downloadImageBtn" class="action-btn download-btn">
                    <span class="btn-icon">üñºÔ∏è</span>
                    <span class="btn-text">ÁîªÂÉè„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</span>
                </button>
            </div>
        </div>
        
        <div class="preview-panel">
            <h2 style="margin-bottom: 8px; font-size: 12px; font-weight: 600;">„Éó„É¨„Éì„É•„Éº</h2>
            <div id="moonArt" class="moon-art"><!-- ÁîüÊàêÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô --></div>
            
            <!-- Debug controls (hidden for production) -->
            <div style="margin-top: 20px; display: none;">
                <label>
                    <input type="checkbox" id="showDebugCanvas"> ÊòæÁ§∫ÂéüÂßãCanvasË∞ÉËØï
                </label>
            </div>
            
            <!-- Debug canvas (hidden for production) -->
            <canvas id="debugCanvas" style="border: 1px solid #666; margin-top: 10px; background: white; display: none; max-width: 100%;"></canvas>
            
            <!-- Debug info -->
            <div id="debugInfo" class="debug-info"></div>
        </div>
    </div>

    <script>
        // ÂéüÈ°πÁõÆÁöÑÁ≤æÁ°ÆÂ∏∏ÈáèÂÆö‰πâ
        const COLOR_LEVELS = {
            BLACK: 0,
            GRAY1: 1, 
            GRAY2: 2,
            GRAY3: 3,
            WHITE: 4,
            SUPER_WHITE: 5
        };
        
        // Á≤æÁ°ÆÁöÑÈ¢úËâ≤ÈòàÂÄºÔºàÂü∫‰∫éÂéüÈ°πÁõÆÔºâ- Ë∞ÉÊï¥ÂáèÂ∞ëÊäóÈîØÈΩøÂΩ±Âìç
        const COLOR_THRESHOLDS = [63, 127, 191, 200, 235]; // Èôç‰ΩéÁôΩËâ≤ÈòàÂÄºÔºåËÆ©Êõ¥Â§öÊµÖÁÅ∞Ëâ≤Ë¢´Âà§ÂÆö‰∏∫ÁôΩËâ≤
        
        // ÁÆÄÂåñÁöÑÊúàÁõ∏Ê®°Âºè
        const MOON_PHASES = ['üåë', 'üåí', 'üåì', 'üåî', 'üåï', 'üåñ', 'üåó', 'üåò'];
        
        class SimpleMoonGenerator {
            constructor() {
                this.debugMode = true;
                this.horizontalThreshold = 4; // ÈªòËÆ§ÈòàÂÄº
            }
            
            // ÊñπÂêëÊÄßËÜ®ËÉÄÊìç‰Ωú - ‰∏ªË¶ÅÂú®ÂûÇÁõ¥ÊñπÂêëÂ°´ÂÖÖÈó¥ÈöôÔºåÈÅøÂÖçÊ®™Á∫øÂèòÂéö
            dilatePixels(pixels, width, height) {
                const result = [];
                for (let y = 0; y < height; y++) {
                    result[y] = [];
                    for (let x = 0; x < width; x++) {
                        let shouldDilate = false;
                        
                        // Ê£ÄÊü•ÂûÇÁõ¥ÈÇªÂüüÔºà‰∏ä‰∏ãÔºâ- ‰∏ªË¶ÅËÜ®ËÉÄÊñπÂêë
                        const verticalNeighbors = [
                            [y-1, x], [y+1, x]  // ‰∏ä„ÄÅ‰∏ã
                        ];
                        
                        for (const [ny, nx] of verticalNeighbors) {
                            if (ny >= 0 && ny < height && nx >= 0 && nx < width) {
                                if (pixels[ny][nx] === COLOR_LEVELS.BLACK) {
                                    shouldDilate = true;
                                    break;
                                }
                            }
                        }
                        
                        // Â¶ÇÊûúÂûÇÁõ¥ÊñπÂêëÊ≤°ÊúâÈªëËâ≤ÈÇªÂ±ÖÔºåÂÜçÊ£ÄÊü•Ê∞¥Âπ≥ÊñπÂêëÔºàÊõ¥‰∏•Ê†ºÊù°‰ª∂Ôºâ
                        if (!shouldDilate) {
                            const horizontalNeighbors = [
                                [y, x-1], [y, x+1]  // Â∑¶„ÄÅÂè≥
                            ];
                            
                            let horizontalBlackCount = 0;
                            for (const [ny, nx] of horizontalNeighbors) {
                                if (ny >= 0 && ny < height && nx >= 0 && nx < width) {
                                    if (pixels[ny][nx] === COLOR_LEVELS.BLACK) {
                                        horizontalBlackCount++;
                                    }
                                }
                            }
                            
                            // Âè™ÊúâÂú®‰∏§‰æßÈÉΩÊòØÈªëËâ≤Êó∂ÊâçÊ∞¥Âπ≥ËÜ®ËÉÄÔºàÈÅøÂÖçÊ®™Á∫øÂèòÂéöÔºâ
                            shouldDilate = horizontalBlackCount >= 2;
                        }
                        
                        result[y][x] = shouldDilate ? COLOR_LEVELS.BLACK : pixels[y][x];
                    }
                }
                return result;
            }
            
            // Èó≠ËøêÁÆó - ÂÖàËÜ®ËÉÄÂêéËÖêËöÄÔºåÂ°´ÂÖÖÂÜÖÈÉ®Á©∫Èöô
            morphClose(pixels, width, height) {
                // ËÜ®ËÉÄÊìç‰Ωú
                const dilated = this.dilatePixels(pixels, width, height);
                
                // ËÖêËöÄÊìç‰Ωú
                const result = [];
                for (let y = 0; y < height; y++) {
                    result[y] = [];
                    for (let x = 0; x < width; x++) {
                        if (dilated[y][x] === COLOR_LEVELS.BLACK) {
                            let blackNeighborCount = 0;
                            
                            // Ê£ÄÊü•4ÈÇªÂüüÁöÑÈªëËâ≤ÂÉèÁ¥†Êï∞
                            const directions = [[0,1], [0,-1], [1,0], [-1,0]];
                            for (const [dy, dx] of directions) {
                                const ny = y + dy;
                                const nx = x + dx;
                                
                                if (ny >= 0 && ny < height && nx >= 0 && nx < width) {
                                    if (dilated[ny][nx] === COLOR_LEVELS.BLACK) {
                                        blackNeighborCount++;
                                    }
                                }
                            }
                            
                            // Ëá≥Â∞ëÊúâ2‰∏™ÈªëËâ≤ÈÇªÂ±ÖÊâç‰øùÊåÅÈªëËâ≤
                            result[y][x] = blackNeighborCount >= 2 ? COLOR_LEVELS.BLACK : pixels[y][x];
                        } else {
                            result[y][x] = dilated[y][x];
                        }
                    }
                }
                return result;
            }
            
            // ÂêéÂ§ÑÁêÜÂπ≥ÊªëÔºöÊ∂àÈô§Â≠§Á´ãÁÇπÂíåÁ™ÅÂÖÄËæπÁºò
            postProcessSmooth(pixels, width, height) {
                const result = [];
                for (let y = 0; y < height; y++) {
                    result[y] = [];
                    for (let x = 0; x < width; x++) {
                        // ÁªüËÆ°Âë®Âõ¥8ÈÇªÂüüÁöÑÈ¢úËâ≤ÂàÜÂ∏É
                        let blackCount = 0;
                        let whiteCount = 0;
                        let totalNeighbors = 0;
                        
                        for (let dy = -1; dy <= 1; dy++) {
                            for (let dx = -1; dx <= 1; dx++) {
                                const ny = y + dy;
                                const nx = x + dx;
                                
                                if (ny >= 0 && ny < height && nx >= 0 && nx < width) {
                                    const pixel = pixels[ny][nx];
                                    if (pixel === COLOR_LEVELS.BLACK) blackCount++;
                                    else if (pixel >= COLOR_LEVELS.WHITE) whiteCount++;
                                    totalNeighbors++;
                                }
                            }
                        }
                        
                        const currentPixel = pixels[y][x];
                        
                        // Â≠§Á´ãÁÇπÊ∂àÈô§ÔºöÂ¶ÇÊûúÂΩìÂâçÂÉèÁ¥†‰∏éÂ§ßÂ§öÊï∞ÈÇªÂ±Ö‰∏çÂêåÔºåÂàôË∞ÉÊï¥
                        if (currentPixel === COLOR_LEVELS.BLACK && blackCount < totalNeighbors * 0.3) {
                            // Â≠§Á´ãÈªëÁÇπ ‚Üí ËΩ¨‰∏∫ËÉåÊôØËâ≤
                            result[y][x] = COLOR_LEVELS.WHITE;
                        } else if (currentPixel >= COLOR_LEVELS.WHITE && blackCount > totalNeighbors * 0.6) {
                            // Ë¢´ÈªëËâ≤ÂåÖÂõ¥ÁöÑÁôΩÁÇπ ‚Üí ËΩ¨‰∏∫ÈªëËâ≤
                            result[y][x] = COLOR_LEVELS.BLACK;
                        } else {
                            // ‰øùÊåÅÂéüËâ≤
                            result[y][x] = currentPixel;
                        }
                    }
                }
                return result;
            }
            
            // ÁÅ∞Â∫¶ÂÄºËΩ¨Êç¢‰∏∫È¢úËâ≤Á∫ßÂà´
            grayToColorLevel(gray) {
                let result;
                if (gray <= COLOR_THRESHOLDS[0]) result = COLOR_LEVELS.BLACK;
                else if (gray <= COLOR_THRESHOLDS[1]) result = COLOR_LEVELS.GRAY1;
                else if (gray <= COLOR_THRESHOLDS[2]) result = COLOR_LEVELS.GRAY2;
                else if (gray <= COLOR_THRESHOLDS[3]) result = COLOR_LEVELS.GRAY3;
                else if (gray <= COLOR_THRESHOLDS[4]) result = COLOR_LEVELS.WHITE;
                else result = COLOR_LEVELS.SUPER_WHITE;
                
                
                return result;
            }
            
            // Ê£ÄÊµãÊ®™Á∫øÊ®°Âºè - Êõ¥‰∏•Ê†ºÁöÑÊ®™Á∫øÂà§Êñ≠
            isHorizontalLine(grid) {
                let rowsWithManyBlack = 0;
                let totalBlackPixels = 0;
                
                for (let y = 0; y < 4; y++) {
                    let blackInRow = 0;
                    for (let x = 0; x < 4; x++) {
                        if (grid[y][x] === COLOR_LEVELS.BLACK) {
                            blackInRow++;
                            totalBlackPixels++;
                        }
                    }
                    if (blackInRow >= 3) rowsWithManyBlack++;
                }
                
                // Êõ¥‰∏•Ê†ºÁöÑÊ®™Á∫øÂà§ÂÆöÊ†áÂáÜÔºö
                // 1. Ëá≥Â∞ëÊúâ2Ë°åÊúâÂ§ö‰∏™ÈªëËâ≤ÂÉèÁ¥† AND ÊÄªÈªëËâ≤ÂÉèÁ¥†Ë∂≥Â§üÂ§ö
                // 2. ÊàñËÄÖÊÄªÈªëËâ≤ÂÉèÁ¥†ÈùûÂ∏∏Â§ö‰∏îÊ∞¥Âπ≥ÂàÜÂ∏ÉÂπø
                const strictHorizontal = rowsWithManyBlack >= 2 && totalBlackPixels >= 10;
                const veryDenseHorizontal = totalBlackPixels >= 12 && this.hasWideHorizontalDistribution(grid);
                
                return strictHorizontal || veryDenseHorizontal;
            }
            
            // Ê£ÄÊµãÊòØÂê¶ÊúâÂπøÊ≥õÁöÑÊ∞¥Âπ≥ÂàÜÂ∏É
            hasWideHorizontalDistribution(grid) {
                let leftBlack = 0, rightBlack = 0;
                for (let y = 0; y < 4; y++) {
                    for (let x = 0; x < 2; x++) {
                        if (grid[y][x] === COLOR_LEVELS.BLACK) leftBlack++;
                    }
                    for (let x = 2; x < 4; x++) {
                        if (grid[y][x] === COLOR_LEVELS.BLACK) rightBlack++;
                    }
                }
                // Â∑¶Âè≥‰∏§‰æßÈÉΩÊúâÈªëËâ≤ÂÉèÁ¥†ÔºåËØ¥ÊòéÊ∞¥Âπ≥ÂàÜÂ∏ÉËæÉÂπø
                return leftBlack >= 2 && rightBlack >= 2;
            }
            
            // Ê£ÄÊµãÁ©∫ÈöôÂå∫ÂüüÔºö‰∏ªË¶ÅÊòØÁôΩËâ≤ÂÉèÁ¥†ÔºåÂèØËÉΩÊúâÂ∞ëÈáèÊäóÈîØÈΩøÁÅ∞Ëâ≤ËæπÁºò
            isGapArea(grid) {
                let whiteOrLightCount = 0;
                let blackOrDarkCount = 0;
                
                for (let y = 0; y < 4; y++) {
                    for (let x = 0; x < 4; x++) {
                        const level = grid[y][x];
                        if (level >= COLOR_LEVELS.GRAY3) { // GRAY3Âèä‰ª•‰∏äËÆ§‰∏∫ÊòØÊµÖËâ≤
                            whiteOrLightCount++;
                        } else if (level <= COLOR_LEVELS.GRAY1) { // GRAY1Âèä‰ª•‰∏ãËÆ§‰∏∫ÊòØÊ∑±Ëâ≤
                            blackOrDarkCount++;
                        }
                    }
                }
                
                // Á©∫ÈöôÁâπÂæÅÔºöÊµÖËâ≤ÂÉèÁ¥†Âç†ÁªùÂ§ßÂ§öÊï∞ÔºåÊ∑±Ëâ≤ÂÉèÁ¥†ÂæàÂ∞ëÔºàÂèØËÉΩÊòØÊäóÈîØÈΩøËæπÁºòÔºâ
                const lightRatio = whiteOrLightCount / 16;
                const darkRatio = blackOrDarkCount / 16;
                
                return lightRatio >= 0.8 && darkRatio <= 0.3;
            }
            
            // Ê£ÄÊµãÊòØÂê¶ÊòØÊ®™Á∫øÁöÑ‰∏ä‰∏ãËæπÁºòÂå∫Âüü
            isPotentialHorizontalArea(grid) {
                // Ê£ÄÊü•ÊØè‰∏ÄË°åÁöÑÈªëËâ≤ÂÉèÁ¥†Êï∞Ôºå‰ªª‰Ωï‰∏ÄË°åÊúâ2+Â∞±ÂèØËÉΩÊòØÊ®™Á∫øÂå∫Âüü
                for (let y = 0; y < 4; y++) {
                    let blackInRow = 0;
                    for (let x = 0; x < 4; x++) {
                        if (grid[y][x] === COLOR_LEVELS.BLACK) blackInRow++;
                    }
                    if (blackInRow >= 2) return true;
                }
                return false;
            }
            
            // Ê£ÄÊµãÊ®™Á∫øÁöÑ‰∏äËæπÁºòÔºöÈªëËâ≤ÂÉèÁ¥†‰∏ªË¶ÅÈõÜ‰∏≠Âú®‰∏ãÂçäÈÉ®ÂàÜÔºàrow 2-3Ôºâ
            isHorizontalTopEdge(grid) {
                let topBlack = 0, bottomBlack = 0;
                
                // ÁªüËÆ°‰∏äÂçäÈÉ®ÂàÜÔºàrow 0-1ÔºâÂíå‰∏ãÂçäÈÉ®ÂàÜÔºàrow 2-3ÔºâÁöÑÈªëËâ≤ÂÉèÁ¥†
                for (let y = 0; y < 2; y++) {
                    for (let x = 0; x < 4; x++) {
                        if (grid[y][x] === COLOR_LEVELS.BLACK) topBlack++;
                    }
                }
                
                for (let y = 2; y < 4; y++) {
                    for (let x = 0; x < 4; x++) {
                        if (grid[y][x] === COLOR_LEVELS.BLACK) bottomBlack++;
                    }
                }
                
                // ‰∏ãÂçäÈÉ®ÂàÜÈªëËâ≤ÂÉèÁ¥†ÊòéÊòæÂ§ö‰∫é‰∏äÂçäÈÉ®ÂàÜÔºåËØ¥ÊòéÊòØÊ®™Á∫øÁöÑ‰∏äËæπÁºò
                return bottomBlack > topBlack && bottomBlack >= 2;
            }
            
            // Ê£ÄÊµãÊ®™Á∫øÁöÑ‰∏ãËæπÁºòÔºöÈªëËâ≤ÂÉèÁ¥†‰∏ªË¶ÅÈõÜ‰∏≠Âú®‰∏äÂçäÈÉ®ÂàÜÔºàrow 0-1Ôºâ
            isHorizontalBottomEdge(grid) {
                let topBlack = 0, bottomBlack = 0;
                
                // ÁªüËÆ°‰∏äÂçäÈÉ®ÂàÜÔºàrow 0-1ÔºâÂíå‰∏ãÂçäÈÉ®ÂàÜÔºàrow 2-3ÔºâÁöÑÈªëËâ≤ÂÉèÁ¥†
                for (let y = 0; y < 2; y++) {
                    for (let x = 0; x < 4; x++) {
                        if (grid[y][x] === COLOR_LEVELS.BLACK) topBlack++;
                    }
                }
                
                for (let y = 2; y < 4; y++) {
                    for (let x = 0; x < 4; x++) {
                        if (grid[y][x] === COLOR_LEVELS.BLACK) bottomBlack++;
                    }
                }
                
                // ‰∏äÂçäÈÉ®ÂàÜÈªëËâ≤ÂÉèÁ¥†ÊòéÊòæÂ§ö‰∫é‰∏ãÂçäÈÉ®ÂàÜÔºåËØ¥ÊòéÊòØÊ®™Á∫øÁöÑ‰∏ãËæπÁºò
                return topBlack > bottomBlack && topBlack >= 2;
            }
            
            // ÊñπÂêëÊÄßÊúàÁõ∏ÈÄâÊã©Á≠ñÁï•
            selectMoonWithContext(grid, neighborInfo = {}) {
                // ‰ºòÂÖàÊ£ÄÊü•ÔºöÁ∫ØÁôΩËâ≤ÁΩëÊ†ºÂøÖÈ°ªËøîÂõûüåëÔºàÁ©∫Èöô‰øùÊä§Êú∫Âà∂Ôºâ
                let pureWhiteCount = 0;
                for (let y = 0; y < 4; y++) {
                    for (let x = 0; x < 4; x++) {
                        if (grid[y][x] >= COLOR_LEVELS.WHITE) {
                            pureWhiteCount++;
                        }
                    }
                }
                
                // Â¶ÇÊûúÊòØÁ∫ØÁôΩËâ≤ÊàñÊé•ËøëÁ∫ØÁôΩËâ≤ÁöÑÁΩëÊ†ºÔºåÁ´ãÂç≥ËøîÂõûüåë
                if (pureWhiteCount >= 15) { // 15/16Êàñ16/16ÁöÑÂÉèÁ¥†ÈÉΩÊòØÁôΩËâ≤
                    return 'üåë';
                }
                
                // ÁâπÊÆäÊÉÖÂÜµÔºöÂ¶ÇÊûúÂú®‰∏§Êù°Ê®™Á∫ø‰πãÈó¥ÔºåÂº∫Âà∂‰ΩøÁî®üåë‰øùÊåÅÂàÜÁ¶ª
                if (neighborInfo.isBetweenHorizontalLines) {
                    return 'üåë';
                }
                
                // ÁªüËÆ°ÈªëËâ≤ÂíåÁôΩËâ≤ÂÉèÁ¥†Êï∞Èáè
                let blackCount = 0;
                let whiteCount = 0;
                
                for (let y = 0; y < 4; y++) {
                    for (let x = 0; x < 4; x++) {
                        const level = grid[y][x];
                        if (level === COLOR_LEVELS.BLACK) {
                            blackCount++;
                        } else if (level >= COLOR_LEVELS.WHITE) {
                            whiteCount++;
                        }
                    }
                }
                
                const blackRatio = blackCount / 16;
                
                
                // Á©∫Èöô‰øùÊä§ÔºöÊ£ÄÊü•ÊòØÂê¶‰∏∫Á©∫ÈöôÂå∫ÂüüÔºàÂ§ßÈÉ®ÂàÜÁôΩËâ≤ÔºåÂ∞ëÈáèÊäóÈîØÈΩøËæπÁºòÔºâ
                if (this.isGapArea(grid)) {
                    return 'üåë';
                }
                
                // Ê£ÄÊµã‰∏ªË¶ÅÁ¨îÁîªÊñπÂêë
                const isHorizontal = this.isHorizontalLine(grid);
                const isVertical = this.isVerticalLine(grid);
                
                // ÂÆûÈôÖÊ®™Á∫øÔºöÂßãÁªàÊòæÁ§∫‰∏∫üåïÔºà‰∏çÂèóÈòàÂÄºÂΩ±ÂìçÔºâ
                if (isHorizontal) {
                    return 'üåï';
                }
                
                // Ê£ÄÊµãÊòØÂê¶‰∏∫Ê®™Á∫øÁöÑ‰∏ä‰∏ãËæπÁºò
                const isTopEdge = this.isHorizontalTopEdge(grid);
                const isBottomEdge = this.isHorizontalBottomEdge(grid);
                
                // Ê®™Á∫ø‰∏ä‰∏ãËæπÁºòÂå∫ÂüüÔºöÂü∫‰∫éÂèØË∞ÉÈòàÂÄºÁöÑ‰∫åÂÄºÂåñÂ§ÑÁêÜ
                if (isTopEdge || isBottomEdge) {
                    // Á©∫Èöô‰øùÁïôÊú∫Âà∂ÔºöÂ¶ÇÊûú‰∏äÊñπÊòØüåïÔºåÂΩìÂâç‰ΩøÁî®üåë‰øùÁïôÁ©∫Èöô
                    if (neighborInfo.hasYellowAbove) {
                        return 'üåë';
                    }
                    
                    // ÁªüËÆ°ÊÄªÈªëËâ≤ÂÉèÁ¥†Êï∞
                    let totalBlack = 0;
                    for (let y = 0; y < 4; y++) {
                        for (let x = 0; x < 4; x++) {
                            if (grid[y][x] === COLOR_LEVELS.BLACK) totalBlack++;
                        }
                    }
                    
                    const edgeResult = totalBlack >= this.horizontalThreshold ? 'üåï' : 'üåë';
                    return edgeResult;
                }
                
                // Á´ñÁ∫øÊ®°ÂºèÔºöÊ∞¥Âπ≥Êâ´ÊèèÔºåÂÖÅËÆ∏ÁÅ∞Â∫¶Ê∏êÂèò
                if (isVertical) {
                    // ËÆ°ÁÆóÂ∑¶Âè≥ÂçäÈÉ®ÂàÜÁöÑÈªëËâ≤ÂÉèÁ¥†ÂàÜÂ∏É
                    let leftBlack = 0, rightBlack = 0;
                    for (let y = 0; y < 4; y++) {
                        for (let x = 0; x < 2; x++) {
                            if (grid[y][x] === COLOR_LEVELS.BLACK) leftBlack++;
                        }
                        for (let x = 2; x < 4; x++) {
                            if (grid[y][x] === COLOR_LEVELS.BLACK) rightBlack++;
                        }
                    }
                    
                    const leftRatio = leftBlack / 8;
                    const rightRatio = rightBlack / 8;
                    
                    // Á´ñÁ∫øÁöÑÊ∞¥Âπ≥Ê∏êÂèòÂ§ÑÁêÜ
                    if (leftRatio > 0.6 && rightRatio > 0.6) return 'üåï';
                    else if (leftRatio > rightRatio + 0.25) {
                        return leftRatio > 0.6 ? 'üåó' : 'üåò'; // Â∑¶ËæπÈªÑËâ≤
                    } else if (rightRatio > leftRatio + 0.25) {
                        return rightRatio > 0.6 ? 'üåì' : 'üåí'; // Âè≥ËæπÈªÑËâ≤
                    } else {
                        const verticalResult = blackRatio > 0.5 ? 'üåî' : 'üåñ';
                        return verticalResult; // Ê∑∑ÂêàÊÉÖÂÜµ
                    }
                }
                
                // Âü∫‰∫éÈªëËâ≤ÂÉèÁ¥†ÈáçÂøÉ‰ΩçÁΩÆÁöÑÊô∫ËÉΩÈÄâÊã©
                if (blackRatio === 0) {
                    return 'üåë';
                }
                else if (blackRatio >= 0.8) {
                    return 'üåï';
                }
                else {
                    // ËÆ°ÁÆóÈªëËâ≤ÂÉèÁ¥†ÁöÑÈáçÂøÉ‰ΩçÁΩÆ
                    let centerX = 0, centerY = 0, blackPixelCount = 0;
                    for (let y = 0; y < 4; y++) {
                        for (let x = 0; x < 4; x++) {
                            if (grid[y][x] === COLOR_LEVELS.BLACK) {
                                centerX += x;
                                centerY += y;
                                blackPixelCount++;
                            }
                        }
                    }
                    
                    if (blackPixelCount === 0) return 'üåë';
                    
                    centerX = centerX / blackPixelCount;  // ÈáçÂøÉXÂùêÊ†áÔºà0-3Ôºâ
                    centerY = centerY / blackPixelCount;  // ÈáçÂøÉYÂùêÊ†áÔºà0-3Ôºâ
                    
                    // Ê†πÊçÆÈªëËâ≤ÊØî‰æãÂíåÈáçÂøÉ‰ΩçÁΩÆÊô∫ËÉΩÈÄâÊã©ÊúàÁõ∏
                    if (blackRatio >= 0.5) {
                        // ÈúÄË¶Å75%ÈªÑËâ≤ÁöÑÊúàÁõ∏ÔºöüåîÊàñüåñ
                        if (centerX <= 1.5) {
                            return 'üåñ'; // ÈªëËâ≤ÈáçÂøÉÂÅèÂ∑¶ ‚Üí Â∑¶ËæπÈªÑËâ≤
                        } else {
                            return 'üåî'; // ÈªëËâ≤ÈáçÂøÉÂÅèÂè≥ ‚Üí Âè≥ËæπÈªÑËâ≤  
                        }
                    } else if (blackRatio >= 0.25) {
                        // ÈúÄË¶Å50%ÈªÑËâ≤ÁöÑÊúàÁõ∏ÔºöüåìÊàñüåó
                        if (centerX <= 1.5) {
                            return 'üåó'; // ÈªëËâ≤ÈáçÂøÉÂÅèÂ∑¶ ‚Üí Â∑¶ËæπÈªÑËâ≤
                        } else {
                            return 'üåì'; // ÈªëËâ≤ÈáçÂøÉÂÅèÂè≥ ‚Üí Âè≥ËæπÈªÑËâ≤
                        }
                    } else if (blackRatio >= 0.1) {
                        // ÈúÄË¶Å25%ÈªÑËâ≤ÁöÑÊúàÁõ∏ÔºöüåíÊàñüåò
                        if (centerX <= 1.5) {
                            return 'üåò'; // ÈªëËâ≤ÈáçÂøÉÂÅèÂ∑¶ ‚Üí Â∑¶ËæπÂ∞ëÈáèÈªÑËâ≤
                        } else {
                            return 'üåí'; // ÈªëËâ≤ÈáçÂøÉÂÅèÂè≥ ‚Üí Âè≥ËæπÂ∞ëÈáèÈªÑËâ≤
                        }
                    } else {
                        return 'üåë'; // ËÉåÊôØ
                    }
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÂëΩ‰∏≠‰ªª‰ΩïÊù°‰ª∂ÔºåËøôÈáå‰∏çÂ∫îËØ•ÊâßË°åÂà∞
                return 'üåë';
            }
            
            // Ê£ÄÊµãËæπÁºòÂáΩÊï∞
            hasTopEdge(grid) {
                return grid[0].some(pixel => pixel === COLOR_LEVELS.BLACK);
            }
            
            hasBottomEdge(grid) {
                return grid[3].some(pixel => pixel === COLOR_LEVELS.BLACK);
            }
            
            hasLeftEdge(grid) {
                return grid.some(row => row[0] === COLOR_LEVELS.BLACK);
            }
            
            hasRightEdge(grid) {
                return grid.some(row => row[3] === COLOR_LEVELS.BLACK);
            }
            
            isVerticalLine(grid) {
                let verticalCols = 0;
                for (let x = 0; x < 4; x++) {
                    let blackInCol = 0;
                    for (let y = 0; y < 4; y++) {
                        if (grid[y][x] === COLOR_LEVELS.BLACK) blackInCol++;
                    }
                    if (blackInCol >= 3) verticalCols++;
                }
                return verticalCols >= 2;
            }

            // 4x4ÁΩëÊ†ºËΩ¨Êç¢‰∏∫ÊúàÁõ∏emojiÔºàÂêëÂêéÂÖºÂÆπÔºâ
            gridToMoon(grid) {
                return this.selectMoonWithContext(grid);
            }
            
            // ÊúàÁõ∏ÂèçËâ≤Â§ÑÁêÜ
            reverseMoon(emoji) {
                const reverseMap = {
                    'üåë': 'üåï', // Êñ∞Êúà ‚Üî Êª°Êúà
                    'üåí': 'üåñ', // ËõæÊúà ‚Üî ‰∫èÊúà
                    'üåì': 'üåó', // ‰∏äÂº¶Êúà ‚Üî ‰∏ãÂº¶Êúà
                    'üåî': 'üåò', // Âá∏Êúà ‚Üî ÊÆãÊúà
                    'üåï': 'üåë', // Êª°Êúà ‚Üî Êñ∞Êúà
                    'üåñ': 'üåí', // ‰∫èÊúà ‚Üî ËõæÊúà
                    'üåó': 'üåì', // ‰∏ãÂº¶Êúà ‚Üî ‰∏äÂº¶Êúà
                    'üåò': 'üåî'  // ÊÆãÊúà ‚Üî Âá∏Êúà
                };
                return reverseMap[emoji] || emoji;
            }
            
            // ËÆæÁΩÆÊ®™Á∫øÈòàÂÄº
            setHorizontalThreshold(threshold) {
                this.horizontalThreshold = threshold;
            }
            
            // ÁîüÊàêÊúàÊñáÂ≠ó
            generate(text, sizeParam = 20, fontType = 'custom', isVertical = true, reverseColor = false) {
                if (!text.trim()) return '';
                
                // Ê†πÊçÆÊéíÁâàÊñπÂêëËÆ°ÁÆócanvasÂ∞∫ÂØ∏
                const chars = Array.from(text);
                const fontFamily = FONT_FAMILIES[fontType] || FONT_FAMILIES['gothic-bold'];
                
                let canvasWidth, canvasHeight, fontSize;
                
                if (isVertical) {
                    // Á´ñÂêëÊéíÁâàÔºösizeParamË°®Á§∫ÂÆΩÂ∫¶ÔºàÊØèË°åÊúà‰∫ÆÂ≠óÁ¨¶Êï∞ÔºâÔºåÈ´òÂ∫¶Ëá™ÈÄÇÂ∫î
                    const targetWidthChars = sizeParam;
                    const targetPixelWidth = targetWidthChars * 4;
                    
                    // ‰∏ÄÊ¨°ÊÄßËÆ°ÁÆóÊúÄÁªàÂ≠ó‰ΩìÂ§ßÂ∞è
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    let estimatedFontSize = Math.max(targetPixelWidth * 0.5, 30);
                    tempCtx.font = `bold ${estimatedFontSize}px ${fontFamily}`;
                    
                    const testChar = chars[0] || 'Êúà';
                    const charMetrics = tempCtx.measureText(testChar);
                    const actualCharWidth = charMetrics.width;
                    const targetCharWidth = targetPixelWidth * 1.1;
                    const scaleFactor = targetCharWidth / actualCharWidth;
                    
                    fontSize = estimatedFontSize * scaleFactor;
                    
                    // CanvasÂ∞∫ÂØ∏Âü∫‰∫éÊúÄÁªàÂ≠ó‰ΩìÂ§ßÂ∞è
                    canvasWidth = targetPixelWidth;
                    canvasHeight = chars.length * fontSize * 0.95 + fontSize * 0.2; // Êõ¥Á¥ßÂáëÁöÑÈ´òÂ∫¶
                } else {
                    // Ê®™ÂêëÊéíÁâàÔºö‰øùÊåÅÂéüÊúâÈÄªËæë
                    const targetPixelHeight = sizeParam * 4;
                    fontSize = targetPixelHeight * 1.0;
                    
                    // ÂàõÂª∫‰∏¥Êó∂canvasÁî®‰∫éÊµãÈáèÊñáÂ≠óÂÆΩÂ∫¶
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.font = `bold ${fontSize}px ${fontFamily}`;
                    
                    const textMetrics = tempCtx.measureText(text);
                    let textWidth = textMetrics.width;
                    
                    if (!textWidth || textWidth < fontSize) {
                        textWidth = text.length * fontSize * 0.8;
                    }
                    
                    const padding = fontSize * 0.5;
                    canvasWidth = Math.max(textWidth + padding * 2, 100);
                    canvasHeight = targetPixelHeight + 30;
                }
                
                // ÂàõÂª∫ÊúÄÁªàcanvasÂπ∂ËÆæÁΩÆÊ≠£Á°ÆÂ∞∫ÂØ∏
                const canvas = document.createElement('canvas');
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                
                const ctx = canvas.getContext('2d');
                
                // È™åËØÅcanvasÂ∞∫ÂØ∏
                const debugInfo = isVertical ? 
                    `Canvas dimensions: ${canvas.width}x${canvas.height}, text: "${text}", chars: ${chars.length}, vertical layout` :
                    `Canvas dimensions: ${canvas.width}x${canvas.height}, text: "${text}", horizontal layout`;
                console.log(debugInfo);
                
                // ÁªòÂà∂ÊñáÂ≠ó
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = 'black';
                ctx.font = `bold ${fontSize}px ${fontFamily}`;
                
                if (isVertical) {
                    // Á´ñÂêëÊéíÁâàÔºö‰ΩøÁî®È¢ÑËÆ°ÁÆóÁöÑÂ≠ó‰ΩìÂ§ßÂ∞èÔºåÁõ¥Êé•ÁªòÂà∂
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';
                    
                    const charHeight = fontSize * 0.95; // Á¥ßÂáëÁöÑÂ≠óÁ¨¶Èó¥Ë∑ù
                    const startY = fontSize * 0.1; // ‰ªéÈ°∂ÈÉ®ÂºÄÂßã
                    
                    chars.forEach((char, index) => {
                        const x = canvas.width / 2;
                        const y = startY + index * charHeight;
                        ctx.fillText(char, x, y);
                    });
                } else {
                    // Ê®™ÂêëÊéíÁâàÔºö‰øùÊåÅÂéüÊúâÈÄªËæë
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(text, canvas.width / 2, canvas.height / 2);
                }
                
                // Ëé∑ÂèñÂõæÂÉèÊï∞ÊçÆ
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Ë∞ÉËØïÔºöÊòæÁ§∫ÂéüÂßãcanvasÊ∏≤ÊüìÁªìÊûú
                const debugCanvas = document.getElementById('debugCanvas');
                const showDebug = document.getElementById('showDebugCanvas')?.checked;
                if (debugCanvas) {
                    if (showDebug) {
                        debugCanvas.style.display = 'block';
                        debugCanvas.width = canvas.width;
                        debugCanvas.height = canvas.height;
                        const debugCtx = debugCanvas.getContext('2d');
                        
                        // Ê∏ÖÈô§Âπ∂ÁªòÂà∂ÂéüÂßãcanvasÂÜÖÂÆπ
                        debugCtx.clearRect(0, 0, debugCanvas.width, debugCanvas.height);
                        debugCtx.drawImage(canvas, 0, 0);
                    } else {
                        debugCanvas.style.display = 'none';
                    }
                }
                
                // Â∞ÜÂõæÂÉèÊï∞ÊçÆËΩ¨Êç¢‰∏∫ÂÉèÁ¥†Áü©Èòµ
                const pixelMatrix = [];
                for (let y = 0; y < canvas.height; y++) {
                    pixelMatrix[y] = [];
                    for (let x = 0; x < canvas.width; x++) {
                        const idx = (y * canvas.width + x) * 4;
                        const gray = 0.299 * imageData.data[idx] + 
                                   0.587 * imageData.data[idx + 1] + 
                                   0.114 * imageData.data[idx + 2];
                        pixelMatrix[y][x] = this.grayToColorLevel(gray);
                    }
                }
                
                // ÊöÇÊó∂Á¶ÅÁî®ÂΩ¢ÊÄÅÂ≠¶Êìç‰ΩúÔºåËßÇÂØüÂéüÂßãÊïàÊûú
                // const processedPixels = this.morphClose(pixelMatrix, canvas.width, canvas.height);
                // const smoothedPixels = this.postProcessSmooth(processedPixels, canvas.width, canvas.height);
                const smoothedPixels = pixelMatrix;
                
                // ÊâæÂà∞Â§ÑÁêÜÂêéÁöÑÊñáÂ≠óËæπÁïå
                let minX = canvas.width, maxX = 0, minY = canvas.height, maxY = 0;
                let foundText = false;
                
                for (let y = 0; y < canvas.height; y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        if (smoothedPixels[y][x] === COLOR_LEVELS.BLACK) {
                            minX = Math.min(minX, x);
                            maxX = Math.max(maxX, x);
                            minY = Math.min(minY, y);
                            maxY = Math.max(maxY, y);
                            foundText = true;
                        }
                    }
                }
                
                if (!foundText) {
                    let defaultResult = 'üåïüåïüåï\nüåïüåïüåï\nüåïüåïüåï';
                    if (reverseColor) {
                        defaultResult = defaultResult.split('').map(char => {
                            if (char === '\n') return char;
                            return this.reverseMoon(char);
                        }).join('');
                    }
                    return defaultResult;
                }
                
                // Âú®ÊñáÂ≠óÂå∫ÂüüÂÜÖËøõË°å4x4ÁΩëÊ†ºÂ§ÑÁêÜÔºåÂª∫Á´ã‰∏ä‰∏ãÊñá‰ø°ÊÅØ
                let result = '';
                const gridSize = 4;
                const boundaryWidth = maxX - minX + 1;
                const boundaryHeight = maxY - minY + 1;
                
                // È¢ÑÂ§ÑÁêÜÔºö‰∏∫ÊØè‰∏™ÁΩëÊ†º‰ΩçÁΩÆÂª∫Á´ã‰∏ä‰∏ãÊñá‰ø°ÊÅØ
                const gridContexts = [];
                
                let alignedMinY, alignedMinX, maxGridX, maxGridY;
                
                if (isVertical) {
                    // Á´ñÂêëÊ®°ÂºèÔºö‰ΩøÁî®Êï¥‰∏™CanvasÂÆΩÂ∫¶ÔºåÈ´òÂ∫¶Âü∫‰∫éÊñáÂ≠óËæπÁïå
                    alignedMinY = Math.floor(minY / gridSize) * gridSize;
                    alignedMinX = 0; // ‰ªéCanvasÂ∑¶ËæπÂºÄÂßã
                    maxGridX = canvas.width - 1; // Âà∞CanvasÂè≥ËæπÁªìÊùü
                    maxGridY = maxY; // È´òÂ∫¶Âü∫‰∫éÊñáÂ≠óÂÆûÈôÖËæπÁïå
                } else {
                    // Ê®™ÂêëÊ®°ÂºèÔºö‰øùÊåÅÂéüÊúâÈÄªËæëÔºåÂü∫‰∫éÊñáÂ≠óÂÆûÈôÖËæπÁïå
                    alignedMinY = Math.floor(minY / gridSize) * gridSize;
                    alignedMinX = Math.floor(minX / gridSize) * gridSize;
                    maxGridX = maxX;
                    maxGridY = maxY;
                }
                
                for (let y = alignedMinY; y <= maxGridY; y += gridSize) {
                    const rowContexts = [];
                    for (let x = alignedMinX; x <= maxGridX; x += gridSize) {
                        // ÊèêÂèñÂΩìÂâç4x4Â≠êÁΩëÊ†º
                        const subGrid = [];
                        for (let dy = 0; dy < 4; dy++) {
                            subGrid[dy] = [];
                            for (let dx = 0; dx < 4; dx++) {
                                const pixelY = y + dy;
                                const pixelX = x + dx;
                                
                                // ËæπÁïåÊ£ÄÊü•ÔºöË∂ÖÂá∫canvasËåÉÂõ¥ÁöÑÂÉèÁ¥†ËÆæ‰∏∫ÁôΩËâ≤
                                if (pixelY >= 0 && pixelY < canvas.height && pixelX >= 0 && pixelX < canvas.width) {
                                    subGrid[dy][dx] = smoothedPixels[pixelY][pixelX];
                                } else {
                                    subGrid[dy][dx] = COLOR_LEVELS.WHITE; // Ë∂ÖÂá∫ËæπÁïåÁöÑÂå∫ÂüüËÆæ‰∏∫ÁôΩËâ≤
                                }
                            }
                        }
                        
                        // Ê£ÄÊµãÂΩìÂâçÁΩëÊ†ºÊòØÂê¶‰∏∫Ê®™Á∫ø
                        const isCurrentHorizontal = this.isHorizontalLine(subGrid);
                        rowContexts.push({ subGrid, isHorizontal: isCurrentHorizontal });
                    }
                    gridContexts.push(rowContexts);
                }
                
                // ÁîüÊàêÊúàÁõ∏ÔºåËÄÉËôë‰∏ä‰∏ãÊñáÂíå‰∏ä‰∏ÄË°åÁöÑËæìÂá∫
                const previousRowOutput = []; // Ë∑üË∏™‰∏ä‰∏ÄË°åÁöÑËæìÂá∫
                
                for (let gridY = 0; gridY < gridContexts.length; gridY++) {
                    const currentRowOutput = [];
                    
                    for (let gridX = 0; gridX < gridContexts[gridY].length; gridX++) {
                        const current = gridContexts[gridY][gridX];
                        
                        // Ê£ÄÊü•‰∏ä‰∏ãÈÇªÂ±ÖÊòØÂê¶‰∏∫Ê®™Á∫ø
                        const hasHorizontalAbove = gridY > 0 ? gridContexts[gridY - 1][gridX]?.isHorizontal : false;
                        const hasHorizontalBelow = gridY < gridContexts.length - 1 ? gridContexts[gridY + 1][gridX]?.isHorizontal : false;
                        
                        // Ê£ÄÊü•‰∏äÊñπÊòØÂê¶‰∏∫ÈªÑËâ≤Êúà‰∫ÆÔºà‰øùÁïôÁ©∫ÈöôÊú∫Âà∂Ôºâ
                        const hasYellowAbove = gridY > 0 && previousRowOutput[gridX] === 'üåï';
                        
                        // ÊûÑÂª∫‰∏ä‰∏ãÊñá‰ø°ÊÅØ
                        const neighborInfo = {
                            isBetweenHorizontalLines: hasHorizontalAbove && hasHorizontalBelow && !current.isHorizontal,
                            hasYellowAbove: hasYellowAbove
                        };
                        
                        // ËΩ¨Êç¢‰∏∫ÊúàÁõ∏
                        let moon = this.selectMoonWithContext(current.subGrid, neighborInfo);
                        
                        
                        currentRowOutput.push(moon);
                        result += moon;
                    }
                    
                    // Êõ¥Êñ∞‰∏ä‰∏ÄË°åËæìÂá∫ËÆ∞ÂΩï
                    previousRowOutput.length = 0;
                    previousRowOutput.push(...currentRowOutput);
                    
                    // Êç¢Ë°åÊù°‰ª∂Ë∞ÉÊï¥
                    if (gridY < gridContexts.length - 1) {
                        result += '\n';
                    }
                }
                
                // Â§ÑÁêÜÊúÄÁªàËæìÂá∫ÔºåÊ†πÊçÆÊéíÁâàÊñπÂêëÂå∫ÂàÜÂ§ÑÁêÜ
                const lines = result.split('\n');
                
                if (isVertical) {
                    // Á´ñÂêëÊ®°ÂºèÔºöÈ´òÂ∫¶Ëá™ÈÄÇÂ∫îÔºåÂè™ÊéßÂà∂ÂÆΩÂ∫¶
                    const targetWidth = sizeParam; // ÁõÆÊ†áÂÆΩÂ∫¶ÔºàÊØèË°åÊúà‰∫ÆÂ≠óÁ¨¶Êï∞Ôºâ
                    
                    // Ë∞ÉÊï¥ÊØèË°åÁöÑÂÆΩÂ∫¶Âà∞ÁõÆÊ†áÂÆΩÂ∫¶
                    const adjustedLines = lines.map(line => {
                        const currentWidth = line.length / 2; // ÂΩìÂâçÂÆΩÂ∫¶
                        if (currentWidth < targetWidth) {
                            // Â¶ÇÊûúÂΩìÂâçÂÆΩÂ∫¶Â∞è‰∫éÁõÆÊ†áÔºåÁî®ÈªëËâ≤ËÉåÊôØÂ°´ÂÖÖ
                            const paddingChar = 'üåë';
                            const padding = paddingChar.repeat(targetWidth - currentWidth);
                            return line + padding;
                        } else if (currentWidth > targetWidth) {
                            // Â¶ÇÊûúÂΩìÂâçÂÆΩÂ∫¶Â§ß‰∫éÁõÆÊ†áÔºåË£ÅÂâ™
                            return line.substring(0, targetWidth * 2);
                        }
                        return line;
                    });
                    
                    let finalResult = adjustedLines.join('\n');
                    
                    // Áªü‰∏ÄÁöÑÂèçËâ≤Â§ÑÁêÜ
                    if (reverseColor) {
                        finalResult = finalResult.split('').map(char => {
                            if (char === '\n') return char;
                            return this.reverseMoon(char);
                        }).join('');
                    }
                    
                    return finalResult;
                } else {
                    // Ê®™ÂêëÊ®°ÂºèÔºö‰øùÊåÅÂéüÊúâÁöÑÈ´òÂ∫¶ÊéßÂà∂ÈÄªËæë
                    const heightRows = sizeParam;
                    
                    if (lines.length < heightRows) {
                        // ËÆ°ÁÆóÈúÄË¶ÅÂ°´ÂÖÖÁöÑË°åÊï∞
                        const paddingRows = heightRows - lines.length;
                        const topPadding = Math.floor(paddingRows / 2);
                        const bottomPadding = paddingRows - topPadding;
                        
                        // ËÆ°ÁÆóÊØèË°åÂ∫îËØ•ÊúâÂ§öÂ∞ë‰∏™emojiÔºàÊ†πÊçÆÁ¨¨‰∏ÄË°åÔºâ
                        const emojisPerLine = lines.length > 0 ? lines[0].length / 2 : 20;
                        const paddingChar = 'üåë';
                        const paddingLine = paddingChar.repeat(emojisPerLine);
                        
                        // Ê∑ªÂä†È°∂ÈÉ®Â°´ÂÖÖ
                        const finalLines = [];
                        for (let i = 0; i < topPadding; i++) {
                            finalLines.push(paddingLine);
                        }
                        
                        // Ê∑ªÂä†ÂÆûÈôÖÂÜÖÂÆπ
                        finalLines.push(...lines);
                        
                        // Ê∑ªÂä†Â∫ïÈÉ®Â°´ÂÖÖ
                        for (let i = 0; i < bottomPadding; i++) {
                            finalLines.push(paddingLine);
                        }
                        
                        return finalLines.join('\n');
                    }
                    
                    // Â¶ÇÊûúÁîüÊàêÁöÑË°åÊï∞Â§ö‰∫éË¶ÅÊ±ÇÔºåË£ÅÂâ™
                    const finalLines = lines.slice(0, heightRows);
                    let finalResult = finalLines.join('\n');
                    
                    // Áªü‰∏ÄÁöÑÂèçËâ≤Â§ÑÁêÜ
                    if (reverseColor) {
                        finalResult = finalResult.split('').map(char => {
                            if (char === '\n') return char;
                            return this.reverseMoon(char);
                        }).join('');
                    }
                    
                    return finalResult;
                }
            }
        }
        
        // Â≠ó‰ΩìÊò†Â∞Ñ
        const FONT_FAMILIES = {
            'gothic-bold': '"Ê∏∏„Ç¥„Ç∑„ÉÉ„ÇØ Bold", "Yu Gothic Bold", "„Éí„É©„ÇÆ„ÉéËßí„Ç¥ W8", "Hiragino Kaku Gothic W8", bold sans-serif',
            'hiragino-w8': '"„Éí„É©„ÇÆ„ÉéËßí„Ç¥ W8", "Hiragino Kaku Gothic W8", "„Éí„É©„ÇÆ„ÉéËßí„Ç¥ W9", "Hiragino Kaku Gothic W9", sans-serif',
            'gothic': '"„Éí„É©„ÇÆ„ÉéËßí„Ç¥ ProN", "Hiragino Kaku Gothic ProN", "Ê∏∏„Ç¥„Ç∑„ÉÉ„ÇØ", "Yu Gothic", "MS P„Ç¥„Ç∑„ÉÉ„ÇØ", "MS PGothic", sans-serif',
            'pop': '"HGPÂâµËã±Ëßí„Éù„ÉÉ„Éó‰Ωì", "HGSoeiKakupoptai", "DFPOP„Éü„ÉÉ„ÇØ„Çπ‰Ωì", "Impact", bold sans-serif'
        };

        // Â≠ó‰ΩìÂØπÂ∫îÈòàÂÄºÈÖçÁΩÆ
        const FONT_THRESHOLDS = {
            'gothic-bold': 6,
            'hiragino-w8': 1,
            'gothic': 4,
            'pop': 4
        };
        
        // ÂàùÂßãÂåñ
        const generator = new SimpleMoonGenerator();
        
        // Êõ¥Êñ∞ÊªëÂùóÊ†áÁ≠æÁöÑÂáΩÊï∞
        function updateSliderLabel() {
            const isVertical = document.querySelector('input[name="textDirection"]:checked').value === 'vertical';
            const sliderLabel = document.getElementById('sliderLabel');
            const sliderUnit = document.getElementById('sliderUnit');
            
            if (isVertical) {
                sliderLabel.textContent = 'ÂπÖÊñáÂ≠óÊï∞';
                sliderUnit.textContent = 'ÊñáÂ≠ó';
            } else {
                sliderLabel.textContent = 'È´ò„Åï';
                sliderUnit.textContent = 'Ë°å';
            }
        }
        
        // Â§çÂà∂ÂäüËÉΩ
        function copyToClipboard() {
            const moonArt = document.getElementById('moonArt').textContent;
            if (!moonArt || moonArt.includes('ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ') || moonArt.includes('„Ç®„É©„Éº')) return;
            
            navigator.clipboard.writeText(moonArt).then(() => {
                const copyBtn = document.getElementById('copyBtn');
                const btnText = copyBtn.querySelector('.btn-text');
                const originalText = btnText.textContent;
                
                btnText.textContent = '„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ';
                copyBtn.classList.add('success');
                
                setTimeout(() => {
                    btnText.textContent = originalText;
                    copyBtn.classList.remove('success');
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }
        
        // ÊñáÊú¨‰∏ãËΩΩÂäüËÉΩ
        function downloadText() {
            const moonArt = document.getElementById('moonArt').textContent;
            if (!moonArt || moonArt.includes('ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ') || moonArt.includes('„Ç®„É©„Éº')) return;
            
            const randomId = Math.random().toString(36).substring(2, 8);
            const filename = `moon-art-${randomId}-${Date.now()}.txt`;
            
            const blob = new Blob([moonArt], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        // ÂõæÁâá‰∏ãËΩΩÂäüËÉΩ
        function downloadImage() {
            const moonArt = document.getElementById('moonArt').textContent;
            if (!moonArt || moonArt.includes('ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ') || moonArt.includes('„Ç®„É©„Éº')) return;
            
            // ÂàõÂª∫ÁîªÂ∏É
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const lines = moonArt.split('\n');
            const fontSize = 20;
            const lineHeight = fontSize;
            
            // ËÆ°ÁÆóÁîªÂ∏ÉÂ∞∫ÂØ∏
            canvas.width = lines[0].length * fontSize / 2;
            canvas.height = lines.length * lineHeight;
            
            // ËÆæÁΩÆËÉåÊôØ
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ÁªòÂà∂Êúà‰∫ÆËâ∫ÊúØ
            ctx.font = `${fontSize}px sans-serif`;
            ctx.textBaseline = 'top';
            
            lines.forEach((line, lineIndex) => {
                let x = 0;
                for (let i = 0; i < line.length; i += 2) {
                    const emoji = line.substr(i, 2);
                    ctx.fillText(emoji, x, lineIndex * lineHeight);
                    x += fontSize;
                }
            });
            
            // ‰∏ãËΩΩÂõæÁâá
            const randomId = Math.random().toString(36).substring(2, 8);
            const filename = `moon-art-${randomId}-${Date.now()}.png`;
            
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);
            }, 'image/png');
        }
        
        function updatePreview() {
            const text = document.getElementById('textInput').value.trim();
            const sizeValue = parseInt(document.getElementById('heightSlider').value);
            const fontType = document.getElementById('fontSelect').value;
            const threshold = parseInt(document.getElementById('thresholdSlider').value);
            const isVertical = document.querySelector('input[name="textDirection"]:checked').value === 'vertical';
            const reverseColor = document.getElementById('reverseColor').checked;
            
            if (!text) {
                document.getElementById('moonArt').textContent = '<!-- ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ -->';
                document.getElementById('actionButtons').style.display = 'none';
                return;
            }
            
            try {
                // ËÆæÁΩÆÈòàÂÄºÂπ∂ÁîüÊàê
                generator.setHorizontalThreshold(threshold);
                const result = generator.generate(text, sizeValue, fontType, isVertical, reverseColor);
                document.getElementById('moonArt').textContent = result;
                
                // ÊòæÁ§∫Êìç‰ΩúÊåâÈíÆ
                document.getElementById('actionButtons').style.display = 'flex';
                
                // Ë∞ÉËØï‰ø°ÊÅØ
                const charCount = result.replace(/\n/g, '').length;
                const lineCount = result.split('\n').length;
                const direction = isVertical ? 'Á∏¶Êõ∏„Åç' : 'Ê®™Êõ∏„Åç';
                const sizeLabel = isVertical ? `ÂπÖ: ${sizeValue}ÊñáÂ≠ó` : `È´ò„Åï: ${sizeValue}Ë°å`;
                document.getElementById('debugInfo').textContent = 
                    `ÊñáÂ≠óÊï∞: ${charCount}, Ë°åÊï∞: ${lineCount}, ${sizeLabel}, Â≠ó‰Ωì: ${fontType}, ÊñπÂêë: ${direction}, ÈòàÂÄº: ${threshold}(Ëá™Âãï)`;
                    
            } catch (error) {
                console.error('Generation error:', error);
                document.getElementById('moonArt').textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                document.getElementById('actionButtons').style.display = 'none';
            }
        }
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        // Ê£ÄÊµãÊòØÂê¶‰∏∫ÁßªÂä®ËÆæÂ§á
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (navigator.maxTouchPoints && navigator.maxTouchPoints > 1) ||
                   window.innerWidth <= 768;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const heightSlider = document.getElementById('heightSlider');
            const heightValue = document.getElementById('heightValue');
            const thresholdSlider = document.getElementById('thresholdSlider');
            const thresholdValue = document.getElementById('thresholdValue');
            
            heightSlider.addEventListener('input', () => {
                heightValue.textContent = heightSlider.value;
                updatePreview();
            });
            
            thresholdSlider.addEventListener('input', () => {
                thresholdValue.textContent = thresholdSlider.value;
                updatePreview();
            });
            
            document.getElementById('textInput').addEventListener('input', updatePreview);
            document.getElementById('fontSelect').addEventListener('change', (e) => {
                // ÂàáÊç¢Â≠ó‰ΩìÊó∂Ëá™Âä®ËÆæÁΩÆÂØπÂ∫îÁöÑÈªòËÆ§ÈòàÂÄº
                const fontType = e.target.value;
                const defaultThreshold = FONT_THRESHOLDS[fontType] || 6;
                thresholdSlider.value = defaultThreshold;
                thresholdValue.textContent = defaultThreshold;
                updatePreview();
            });
            document.getElementById('showDebugCanvas').addEventListener('change', updatePreview);
            
            // Ê∑ªÂä†ÊñπÂêëÈÄâÊã©‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.querySelectorAll('input[name="textDirection"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    updateSliderLabel(); // Êõ¥Êñ∞Ê†áÁ≠æ
                    updatePreview(); // ÈáçÊñ∞ÁîüÊàê
                });
            });
            
            // Ê∑ªÂä†ÂèçËâ≤Â§çÈÄâÊ°Ü‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('reverseColor').addEventListener('change', updatePreview);
            
            // Ê∑ªÂä†ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
            document.getElementById('downloadTextBtn').addEventListener('click', downloadText);
            document.getElementById('downloadImageBtn').addEventListener('click', downloadImage);
            
            // ‰ªÖÂú®Ê°åÈù¢ËÆæÂ§á‰∏äÊ∑ªÂä†Êî∂ËóèÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
            if (!isMobileDevice()) {
                document.getElementById('bookmarkBtn').addEventListener('click', addBookmark);
            } else {
                // ÁßªÂä®ËÆæÂ§á‰∏äÂÆåÂÖ®ÈöêËóèÊåâÈíÆ
                const bookmarkBtn = document.getElementById('bookmarkBtn');
                if (bookmarkBtn) {
                    bookmarkBtn.style.display = 'none';
                }
            }
            
            // Ê†πÊçÆËÆæÂ§áÁ±ªÂûãËÆæÁΩÆÈªòËÆ§ÊñπÂêë
            if (isMobileDevice()) {
                document.querySelector('input[name="textDirection"][value="vertical"]').checked = true;
            } else {
                document.querySelector('input[name="textDirection"][value="horizontal"]').checked = true;
            }
            
            // ÂàùÂßãÂåñÊ†áÁ≠æÂíåÁîüÊàê
            updateSliderLabel();
            updatePreview();
            
            // ËÆæÁΩÆÈ°µËÑöÊî∂ËóèÊåâÈíÆ
            setupFooterBookmark();
        });
        
        // Êî∂ËóèÂäüËÉΩ
        function addBookmark() {
            const title = 'ÊúàÊñáÂ≠ó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº - MojiMoon';
            const url = 'https://mojimoon.com';
            
            try {
                // Áé∞‰ª£ÊµèËßàÂô®ÁöÑÂ§ÑÁêÜ
                if (navigator.userAgent.indexOf('Chrome') > -1 || navigator.userAgent.indexOf('Safari') > -1) {
                    // Chrome/Safari: ÊòæÁ§∫ÂèãÂ•ΩÁöÑÊèêÁ§∫
                    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                    const shortcut = isMac ? 'Cmd+D' : 'Ctrl+D';
                    alert(`${shortcut} „ÇíÊäº„Åó„Å¶„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑüåô`);
                } else if (window.sidebar && window.sidebar.addPanel) {
                    // Firefox
                    window.sidebar.addPanel(title, url, '');
                } else if (window.external && window.external.AddFavorite) {
                    // Internet Explorer
                    window.external.AddFavorite(url, title);
                } else {
                    // ÂÖ∂‰ªñÊµèËßàÂô®
                    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                    const shortcut = isMac ? 'Cmd+D' : 'Ctrl+D';
                    alert(`${shortcut} „ÇíÊäº„Åó„Å¶„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ`);
                }
            } catch (error) {
                console.error('Bookmark error:', error);
                alert('„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†„Åô„Çã„Å´„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÅÆ„É°„Éã„É•„Éº„Åã„ÇâÊìç‰Ωú„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }
        
        // „Éï„ÉÉ„Çø„ÉºÂèéËóèÊåâÈíÆ‰∫ã‰ª∂
        function setupFooterBookmark() {
            const footerBookmarkBtn = document.getElementById('footerBookmarkBtn');
            if (footerBookmarkBtn && !isMobileDevice()) {
                footerBookmarkBtn.addEventListener('click', addBookmark);
            } else if (footerBookmarkBtn) {
                // ÁßªÂä®ËÆæÂ§á‰∏äÈöêËóèfootter‰∏≠ÁöÑÊî∂ËóèÊåâÈíÆ
                footerBookmarkBtn.style.display = 'none';
            }
        }
    </script>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <h2 style="text-align: center; margin-bottom: 15px; font-size: 1.2rem; font-weight: 600; color: #374151;">„Åì„ÅÆ„Çµ„Ç§„Éà„ÅåÊ∞ó„Å´ÂÖ•„Å£„Åü„Çâ„ÄÅ„Åú„Å≤<button id="footerBookmarkBtn" class="footer-bookmark-btn" title="„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†">„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ</button>„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
        </div>
    </footer>
</body>
</html>